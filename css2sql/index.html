<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
  	<title>css âžž sql</title>
    <link rel="shortcut icon" href="favicon.png">
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-x: hidden;
        overflow-y: hidden;
        background: #E5E9EB;
        font-family: Helvetica, Calibri, sans-serif;
      }
      #input {
        display: block;
        width: 40vw;
        margin: 30vh auto 20px auto;
        text-align: center;
        font-size: 20px;
        padding: 15px;
      }
      #output {
        display: block;
        width: 40vw;
        margin: 20px auto;
        text-align: center;
        font-size: 20px;
        color: #888;
        background: #eee;
        padding: 15px;
      }
    </style>
  </head>
  <body>
    <div class="wrap">

      <input id="input" spellcheck="false" placeholder="Enter css here...">
      <div id="output"></div>

    </div>

    <script>
      var input = document.getElementById('input')
      var output = document.getElementById('output')

      function css2sql(selector) {
        function unary(s) {
          var parts = s.split(/:|\[|#/)
          var operation = null

          var picker = '*'
          var where = (s.match(/\[.*?\]/g) || []).map(e => e.substr(1,e.length-2))
          var pseudo = (s.match(/:[-_0-9a-zA-Z()]*/) || [''])[0]
          var id = (s.match(/#[-_0-9a-zA-Z()]*/) || [''])[0]

          if (pseudo.substr(0,5) === ':sum(') picker = pseudo.substr(1)
          if (pseudo.substr(0,7) === ':count(') picker = pseudo
          if (pseudo === ':first-child') operation = 'ORDER BY date ASC LIMIT 1'
          if (pseudo === ':last-child') operation = 'ORDER BY date DESC LIMIT 1'
          if (id[0] === '#') where.push('id=' + id.substr(1))
          return {
            table: parts[0],
            picker: picker,
            where: where,
            operation: operation
          }
        }
        var ast = unary(selector)
        console.log('ast', ast)
        var wheres = ast.where.length ? ' WHERE ' + ast.where.join(' AND ') : ''
        return `SELECT ${ast.picker} FROM ${ast.table}${wheres} ${ast.operation || ''}`
      }

      function onchange() {
        var css = input.value
        try {
          output.innerHTML = css2sql(css)
        } catch(e) {
          output.innerHTML = 'could not transpile, please try something else'
        }
      }

      input.addEventListener('input', onchange)

    </script>

  </body>
</html>

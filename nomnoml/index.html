<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>nomnoml</title>
<link href='//fonts.googleapis.com/css?family=Dosis:400' rel='stylesheet' type='text/css'>
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<link rel="stylesheet" href="../cluster/css/boilerplate.css">
<link rel="stylesheet" href="../cluster/css/normalize.css">
<link rel="shortcut icon" href="favicon.png">
<link rel="apple-touch-icon" href="img/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png">
<style>

html, body {
	height: 100%;
	overflow-x: hidden;
	overflow-y: hidden;
}
.wrap {
	position: relative;
	background: #E5E9EB;
	min-height: 100%;
}
#textarea {
	outline: none;
	position: absolute;
	width: 100%;
	height: 40%;
	box-sizing: border-box;
	background: #E5E9EB;
	border: 0;
	font-family: Consolas, monospace;
	color: #444;
	padding: 30px;
}
#canvas {
	position: absolute;
	bottom: 0;
}
a, a:hover, a:active {
	color: #888;
	text-decoration: none
}
a:hover {
	color: #aaa;
}
.tools {
	display: block;
	position: absolute;
	top: 20px;
	right: 40px;
	color: #888;
	text-shadow: 0 1px 0px rgba(255, 255, 255, 0.5);
	font-family: Helvetica, sans-serif;
	font-weight: bold
}
.tools>span {
	font-size: 150%;
}
</style>
</head>
<body>
	<div class="wrap">

		<canvas id="canvas" width="800" height="800"></canvas>
		<textarea id="textarea">[apa]->[banan]
[apa]->[kokos]</textarea>

		<div class="tools">
			<span>nomnoml &nbsp;&nbsp;</span>
			<a href="javascript:discardCurrentGraph()">
				<i class="fa fa-fw fa-trash-o fa-lg"></i>
			</a>
			<a id="savebutton" href="javascript:void(0)" download="uml.png">
				<i class="fa fa-fw fa-camera fa-lg"></i>
			</a>
		</div>
	</div>

	<script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
	<script src="underscore.js"></script>
	<script src="dagre.min.js"></script>
	<script src="../cluster/canvas.js"></script>
	<script src="../cluster/vector.js"></script>
	<script type="text/nomnoml" id="defaultGraph">[marauder]<:-[pirate]
[pirate]-[mischief]
[jollyness]->[pirate]
[jollyness]->[rum]
[jollyness]->[singing]
[pirate]->[rum]
[pirate]->[singing]
[singing]<->[rum]
	</script>
	<script>

	(function (){
		var link = document.getElementById('savebutton')
		link.addEventListener('click', downloadImage, false);
		function downloadImage(){
			var url = canvas.toDataURL('image/png')
			var downloadUrl = url.replace(/^data:image\/[^;]/, 'data:application/octet-stream')
		    link.href = downloadUrl;
		}
	}())

	function fillScreen(){
		w = canvas.parentElement.offsetWidth
		h = canvas.parentElement.offsetHeight
		canvas.setAttribute('width', w)
		canvas.setAttribute('height', h*0.6-1)
		sourceChanged()
	}

	var w, h;
	var canvas = document.getElementById('canvas')
	var textarea = document.getElementById('textarea')
	var g = skanaar.Canvas(canvas, {})
	var fontSize = 14
	window.addEventListener('resize', _.throttle(fillScreen, 750, {leading: true}))
	textarea.addEventListener('input', sourceChanged)
	textarea.value = localStorage.getItem('nomnoml.lastSource') || document.getElementById('defaultGraph').innerHTML
	fillScreen()

	function discardCurrentGraph(){
		textarea.value = document.getElementById('defaultGraph').innerHTML
		sourceChanged()
	}

	function sourceChanged(){
		g.ctx.font = ' '+fontSize+'pt Calibri, sans-serif'
		var ast = parse(textarea.value)
		localStorage.setItem('nomnoml.lastSource', textarea.value)
		render(layout(ast, measureNode))
	}

	function measureNode(node){
		return { width: g.ctx.measureText(node.name).width + 25, height: fontSize + 25 }
	}

	function parse(source){
		var pattern = /\[(.*)\](-:>|->|<:-|<-|<->|-)\[(.*)\]/
		function parseLine(s){
			var parts = s.match(pattern)
			return parts && _.map(_.tail(parts), function (p){ return p.trim() })
		}
		var lines = source.split('\n')
		var bimap = _.compact(_.map(lines, parseLine))
		var nodes = {}
		var relations = []
		_.each(bimap, function (pair){
			var left = pair[0]
			var right = pair[2]
			nodes[left] = { name: left, x: _.random(600), y: _.random(400) }
			nodes[right] = { name: right, x: _.random(600), y: _.random(400) }
			var isLeftToRight = pair[1][0] === '-'
			var a = isLeftToRight ? left : right
			var b = isLeftToRight ? right : left
			var t = {
				'-:>': 'generalization',
				'->': 'dependency',
				'<:-': 'generalization',
				'<-': 'dependency',
				'<->': 'twoway',
				'-': 'nondirectional' 
			}[pair[1]]
			relations.push({start: a, end:b, type: t})
		})
		return { nodes: nodes, relations: relations }
	}

	function layout(ast, measureNode){
		function buildDagreGraph(ast){
			var g = new dagre.Digraph()
			_.each(ast.nodes, function (e, key){
				var size = measureNode(e)
				g.addNode(key, { label: key, width: size.width, height: size.height })
			})
			_.each(ast.relations, function (r){
				g.addEdge(null, r.start, r.end)
			})
			return g
		}
		function packageDagreGraph(ast, dagreLayout){
			var nodes = {}
			var relations = []
			dagreLayout.eachNode(function (key, data){
				nodes[key] = { name: key, x: data.x, y: data.y, width: data.width, height: data.height }
			})
			dagreLayout.eachEdge(function (id, start, end, data){
				relations.push({
					start: nodes[start],
					middle: _.pick(data, 'x', 'y'),
					end: nodes[end],
					path: _.flatten([nodes[start], data.points, nodes[end]]),
					type: _.findWhere(ast.relations, {start: start, end: end}).type
				})
			})
			return { nodes: nodes, relations: relations }
		}
		return packageDagreGraph(ast, dagre.layout().run(buildDagreGraph(ast)))
	}

	function render(layout){
		g.ctx.save()
		g.ctx.clearRect(0, 0, w, h)
		g.ctx.translate(50, 50)
		g.ctx.strokeStyle = '#111'
		g.ctx.textAlign = 'center'
		g.ctx.lineWidth = 1

		function drawArrow(path, type){
			var v = diff(path[path.length-2], _.last(path))
			var nv = normalize(v)
			var p2_ = add(_.last(path), mult(nv, mag(v)*0.6))
			var t = rot(nv)
			var arrowBase = add(p2_, mult(nv, 8))
			var arrowPoint = add(p2_, mult(nv, -2))
			var arrow = [
				arrowPoint,
				add(arrowBase, mult(t, 5)),
				add(arrowBase, mult(t, -5)),
				arrowPoint
			]
			g.ctx.fillStyle = (type === 'dependency') ? '#111' : '#fff'
			var ctx = g.path(arrow).fill().stroke()
		}

		_.each(layout.relations, function (r){
			g.path(r.path).stroke()
			if (r.type === 'nondirectional') return
			if (r.type === 'twoway'){
				drawArrow(r.path, 'dependency')
				drawArrow(_.clone(r.path).reverse(), 'dependency')
			}
			else
				drawArrow(r.path, r.type)
		})
		g.ctx.lineWidth = 1
		_.each(layout.nodes, function (e){
			var w = e.width
			var h = e.height
			g.ctx.fillStyle = 'rgba(200, 200, 200, 1)'
			g.ctx.fillRect(e.x-w/2, e.y-h/2, w, h)
			g.ctx.strokeRect(e.x-w/2, e.y-h/2, w, h)
			g.ctx.fillStyle = '#333'
			g.ctx.fillText(e.name, e.x, e.y+fontSize/2-1)
		})
		g.ctx.restore()
	}

	</script>
</body>
</html>
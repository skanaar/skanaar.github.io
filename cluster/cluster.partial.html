<div class="full-row jumbotron withsubtitle">
<h1>{{clusterName}}: {{companyName}}</h1>
<small>Building: {{clusterProperties.building | number:0}}% &nbsp; &nbsp; &nbsp; 
Nutrition: {{clusterProperties.nutrition | number:0}}% &nbsp; &nbsp; &nbsp; 
Mobility: {{clusterProperties.mobility | number:0}}%</small></div>
<div class="full-row page-stripe toolbar">
	<div class="pull-right">
		<a id="download-image-link" download="cluster-snapshot.png">
			<i class="fa fa-camera"></i></a>
		<a onclick="engine.zoom(-1)" href="javascript:void(0)">
			<i class="fa fa-plus"></i></a>
		<a onclick="engine.zoom(1)" href="javascript:void(0)">
			<i class="fa fa-minus"></i></a>
	</div>
	<div>
		<a ng-class="{active: activePane === 'filter'}"
		   ng-click="togglePane('filter')" href="javascript:void(0)">Filter</a>
		<a ng-class="{active: activePane === 'current'}"
		   ng-click="togglePane('current')" href="javascript:void(0)">Current</a>
		<a ng-class="{active: activePane === 'develop'}"
		   ng-click="togglePane('develop')" href="javascript:void(0)">Develop</a>
		<a ng-class="{active: activePane === 'legend'}"
		   ng-click="togglePane('legend')" href="javascript:void(0)">Legend</a>
	</div>
</div>
<div style="position: relative">
	<canvas id="canvas" width="800" height="800"></canvas>
	<div class="sidebar details_sidebar" ng-show="selectedEntity">
		<div>
			<div>
				<a class="pull-right"
				   onclick="engine.centerSelected()" 
				   href="javascript:void(0)"><i class="fa fa-crosshairs fa-2x"></i></a>
				<h2>{{selectedEntity.name}} </h2>
			</div>
			<div>{{selectedEntity.description}}</div>
			<hr>
			<div><label>Email</label> {{selectedEntity.email}}</div>
			<div><label>Company</label> {{selectedEntity.company}}</div>
			<div><label>Id</label> {{selectedEntity.id}}</div>
			<hr>
			<div class="toolset">
				<a ng-click="showSelectClusterPane = true" href="javascript:void(0)">
					<i class="fa fa-fw fa-plus-circle"></i> Add related solution
				</a>
				<a>
					Relation type:
					<select ng-options="e for e in relationTypes" ng-model="newRelationType">
					</select>
				</a>
			</div>
		</div>
	</div>
	<div class="sidebar details_sidebar" ng-show="selectedRelation">
		<div>
			<h2>{{selectedRelation.start.name}} - {{selectedRelation.end.name}}</h2>
			<div>{{selectedRelation.description}}</div>
			<hr>
			<div><label>Type</label> <em style="width: 100px">{{selectedRelation.type}}</em></div>
			<div><label>Date</label> {{selectedRelation.date}}</div>
			<div><label>Author</label> {{selectedRelation.author}}</div>
		</div>
	</div>
	<div class="sidebar search_sidebar"
		 id="search_sidebar"
		 ng-show="activePane === 'filter'">
		<div>
			<h3>Filter</h3>
			Mobility  <em>&gt; {{filter.mobility}}%</em>
			<div><input type="range" ng-model="filter.mobility"></div>
			Nutrition <em>&gt; {{filter.nutrition}}%</em>
			<div><input type="range" ng-model="filter.nutrition"></div>
			Building  <em>&gt; {{filter.building}}%</em>
			<div><input type="range" ng-model="filter.building"></div>
			<hr>
			<label>Solution status</label>
			<div><label><input type="checkbox" ng-model="filter.existing"> Existing</label></div>
			<div><label> <input type="checkbox" ng-model="filter.supporting"> Supporting</label></div>
			<div><label><input type="checkbox" ng-model="filter.potential"> Potential</label></div>
			<label>Solution type</label>
			<div><label><input type="checkbox" ng-model="filter.core"> Core</label></div>
			<div><label><input type="checkbox" ng-model="filter.accelerator"> Accelerator</label></div>
			<div><label><input type="checkbox" ng-model="filter.expander"> Expander</label></div>
			<label>Max age</label>
			<div><label><input type="text" style="width: 50%" ng-model="filter.solutionAge"></label>
			<i class="fa fa-fw fa-minus" ng-click="filter.solutionAge = filter.solutionAge - 10"></i>
			<i class="fa fa-fw fa-plus" ng-click="filter.solutionAge = filter.solutionAge + 10"></i></div>
			<hr>
			<label>Relations</label>
			<div><label><input type="checkbox" ng-model="filter.rel_participant"> Participant</label></div>
			<div><label><input type="checkbox" ng-model="filter.rel_provider"> Provider</label></div>
			<div><label><input type="checkbox" ng-model="filter.rel_catalyst"> Catalyst</label></div>
			<div><label><input type="checkbox" ng-model="filter.rel_potential"> Potential</label></div>
			<div><label><input type="checkbox" ng-model="filter.rel_alternative"> Alternative</label></div>
			<label>Max age</label>
			<div><label><input type="text" style="width: 50%" ng-model="filter.rel_age"></label>
			<i class="fa fa-fw fa-minus" ng-click="filter.rel_age = filter.rel_age - 10"></i>
			<i class="fa fa-fw fa-plus" ng-click="filter.rel_age = filter.rel_age + 10"></i></div>
			<hr>
		</div>
	</div>
	<div class="sidebar legend_sidebar"
		 ng-show="activePane === 'current'">
		<div>
			<h3>Current View</h3>
			<div ng-repeat="e in visibleSolutions">
				<a ng-click="selectEntity(e.id)" href="javascript:void(0)">{{e.name}}</a>
			</div>
		</div>
	</div>
	<div class="sidebar develop_sidebar"
		 ng-show="activePane === 'develop'">
		<div>
			<h3>Develop</h3>
			<div class="toolset">
				<a href="#cluster/blank"><i class="fa fa-fw fa-dot-circle-o"></i> Blank cluster</a>
				<a ng-click="addSolution()"><i class="fa fa-fw fa-plus"></i> Add solution</a>
				<a onclick="engine.runFor(2000)"><i class="fa fa-fw fa-arrow-circle-o-right"></i> Auto layout</a>
				<a id="download-data-link" download="cluster-data.json">
					<i class="fa fa-fw fa-download"></i> Download data</a>
				<h3><i class="fa fa-fw fa-folder-open"></i> Open file</h3>
				<input type="file"
					   onchange="angular.element(this).scope().loadClusterFile(this.files)">
			</div>

			<h3>Selection</h3>
			<div ng-show="selectedEntity">
				<div class="toolset" ng-show="selectedEntity">
					<a ng-click="removeEntity()"><i class="fa fa-fw fa-trash-o"></i> Remove</a>
				</div>
				<label>Name</label>
				<input type="text" ng-model="selectedEntity.name">
				<label>Description</label>
				<input type="text" ng-model="selectedEntity.description">
				<label>Company</label>
				<input type="text" ng-model="selectedEntity.company">
				<label>Status</label>
				<select ng-options="e for e in ['existing', 'supporting', 'potential']"
						ng-model="selectedEntity.status"></select>
				<label>Type</label>
				<select ng-options="e for e in ['core', 'accelerator', 'expander']"
						ng-model="selectedEntity.type"></select><br>

				Mobility  <em>&gt; {{selectedEntity.mobility}}%</em>
				<div><input type="range" ng-model="selectedEntity.mobility"></div>
				Nutrition <em>&gt; {{selectedEntity.nutrition}}%</em>
				<div><input type="range" ng-model="selectedEntity.nutrition"></div>
				Building  <em>&gt; {{selectedEntity.building}}%</em>
				<div><input type="range" ng-model="selectedEntity.building"></div>
			</div>
			<div ng-show="selectedRelation">
				<div class="toolset" ng-show="selectedRelation">
					<a ng-click="removeRelation()"><i class="fa fa-fw fa-trash-o"></i> Remove</a>
				</div>
				<label>Type</label>
				<select ng-options="e for e in relationTypes"
						ng-model="selectedRelation.type"></select><br>
			</div>

		</div>
	</div>
	<div class="sidebar legend_sidebar" ng-show="activePane === 'legend'">
		<div>
			<h3>Legend</h3>
			<div class="entity existing"></div>
			<div class="desc"><b>Existing Solution</b> Solutions that is part of an existing cluster</div>
			<hr><div class="entity supporting"></div>
			<div class="desc"><b>Supporting solution</b> Existing solution that is (not yet) part of the cluster </div>
			<hr><div class="entity potential"></div>
			<div class="desc"><b>Potential solution</b> Possible solution that is not on the market, that could be part of a future cluster</div>
			<hr><div class="entity bordered core"></div>
			<div class="desc"><b>Existing</b> Solution that focus on what the cluster i delivering right now</div>
			<hr><div class="entity bordered accelerator"></div>
			<div class="desc"><b>Accelerator</b> Accelererating solution such a business- or app development</div>
			<hr><div class="entity bordered expander"></div>
			<div class="desc"><b>Expander</b> Solution that broadens the current clusters capacity to deliver solutions into new areas. </div>
			<hr><div class="relation participant"></div>
			<div class="desc"><b>Existing relation</b> Relations established by  existing cluster participants</div>
			<hr><div class="relation supporting"></div>
			<div class="desc"><b>Supporting relation</b> Relation established by  supporting solution providers</div>
			<hr><div class="relation catalyst"></div>
			<div class="desc"><b>Catalyst relation</b> Relation established by  a catalyst</div>
			<hr><div class="relation potential"></div>
			<div class="desc"><b>Potential relation</b> Relation established by a thought leader</div>
			<hr><div class="relation alternative"></div>
			<div class="desc"><b>Alternative relation</b> Two solutions that are potential alternatives</div>
		</div>
	</div>
	<div class="modal" ng-show="showSelectClusterPane">
		<div>
			<a class="pull-right" ng-click="showSelectClusterPane = false">
				<img src="img/icons/close_popup.png" width="42" height="42">
			</a>
			<h2>Add solution to cluster</h2>
			<table>
			<tr>
				<th><a ng-click="sortKey = 'name'">Name</a></th>
				<th><a ng-click="sortKey = 'company'">Company</a></th>
				<th><a ng-click="sortKey = 'date'">Date</a></th>
			</tr>
			<tr ng-repeat="s in allSolutions | orderBy:sortKey">
				<td><a ng-click="add(s)">{{s.name}}</a></td>
				<td><a ng-click="add(s)">{{s.company}}</a></td>
				<td><a ng-click="add(s)">{{s.date}}</a></td>
			</tr>
			</table>
		</div>
	</div>
</div>
<script>

attachDataUrlToLink('download-image-link', 'image/png', function (){
	return document.getElementById('canvas').toDataURL('image/png')
})

attachDataUrlToLink('download-data-link', 'text/json', function (){
	var es = ClusterPlatform.nodes.entities
	var rs = ClusterPlatform.nodes.relations
    var data = {
    	name: ClusterPlatform.cluster.name,
    	centralEntity: ClusterPlatform.cluster.centralEntity,
        entities: _.map(es, function (e){ return _.omit(e, ['$$hashKey', 'fx', 'fy'])}),
        relations:  _.map(rs, function (r){
            return { start: r.start.id, end: r.end.id, type: r.type }
        })
    }
    return 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, undefined, 2))
})


var engine = Engine('canvas', Nodes([], []), { fps: 30 })

window.addEventListener('resize', _.throttle(engine.fillScreen, 750, {leading: true}))
document.getElementById('canvas').addEventListener('wheel', function (e){ engine.zoom(e.deltaY) })
engine.fillScreen()

var ClusterPlatform = { cluster: {}, entities: [], relations: [], engine: engine }

</script>
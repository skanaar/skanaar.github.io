<dev-env>
  <div class=page>
    <code-editor app={app} />
    <rule-simulator app={app} />
  </div>

  <style>
  </style>
  <script>
    const rnd = (low,high) => low + (high-low) * Math.random()
    const listSum = (listA,listB) => listA.map((e,i) => listA[i] + listB[i])
    const round = (x) => Math.round(x)
    const toPath = (data,dx) => 'M' + data.map((e,i) => 2*(dx+i)+','+round(e)).join(' L')

    function smooth(es){
      return es.map((x,i) => (es[Math.max(0,i-1)] + 4*es[i] + es[Math.min(es.length-1,i+1)])/6)
    }
    function noise(source, amp, level) {
      if (!level) { return source }
      var d = _.flatten(source.map(x => [x+rnd(-amp, amp), x, x+rnd(-amp, amp)]))
      return smooth(noise(d, amp*0.75, level-1))
    }
    function Stock(name, color, data) { return { name, color, data } }

    //-----
    
    var self = this
    var env = finscript.env
    var colorIndex = 0
    var colors = '#5777aa #f6ae9b #009ECF #575656 #e8d5a6 #71bb75 #8b5d3b #ff501b #9adae7'.split(' ')
    var omx = Stock('OMX30', '#666', noise([120,120], 60, 5))
    env.symbols.OMX30 = omx

    function fetchStockData(symbol, callback) {
      fetch('/history?symbol=' + symbol.toUpperCase())
        .then(e => e.json())
        .then(e => {
          callback(e.dataPoints.map(pair => pair[1]).reverse())
        })
    }

    env.getSymbol = function (id) {
      if (!this.symbols[id]) {
        var data = noise([120,120], 30, 5).slice(0,252)
        var stock = {name:id, color:colors[colorIndex], data:data}
        fetchStockData(id, function (data) {
          stock.data = data
          self.update()
        })
        this.symbols[id] = stock
        colorIndex = (colorIndex+1) % colors.length
      }
      return this.symbols[id]
    }
    var defaultExample = document.getElementById('example-source').innerHTML.trim()

    self.app = {
      env: env,
      timeRange: 252,
      source: localStorage['finscript:lastSource'] || defaultExample,
      events: riot.observable(),
      setHoldingCount: function (symbol, count) {
        env.getHolding(symbol.name).count = +count
      }
    }

    self.app.events.on('source-changed', src => localStorage['finscript:lastSource'] = src)

  </script>
</dev-env>

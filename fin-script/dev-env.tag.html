<dev-env>
  <div class=page>
    <code-editor app={app} />
    <rule-simulator app={app} />
  </div>

  <style>
  </style>
  <script>
    const clamp = (low, high, x) => Math.max(low, Math.min(high, x))
    const range = (end) => [...Array(end).keys()]
    const rnd = (low,high) => low + (high-low) * Math.random()
    const flatmap = (list, op) => _.flatten(list.map(op))
    const sum = (list) => list.reduce((a,b) => a+b)
    const average = (list) => list.reduce((a,b) => a+b) / list.length
    const max = (list) => list.reduce((a,b) => Math.max(a,b))
    const min = (list) => list.reduce((a,b) => Math.min(a,b))
    const listSum = (listA,listB) => listA.map((e,i) => listA[i] + listB[i])
    const round = (x) => Math.round(x)
    const toPath = (data,dx) => 'M' + data.map((e,i) => 2*(dx+i)+','+round(e)).join(' L')

    function smooth(es){
      return es.map((x,i) => (es[Math.max(0,i-1)] + 4*es[i] + es[Math.min(es.length-1,i+1)])/6)
    }
    function noise(source, amp, level) {
      if (!level) { return source }
      var d = _.flatten(source.map(x => [x+rnd(-amp, amp), x, x+rnd(-amp, amp)]))
      return smooth(noise(d, amp*0.75, level-1))
    }
    function Stock(name, color, data) { return { name, color, data } }

    //-----
    
    var self = this
    var env = finscript.env
    var colors = '#3F3 #F33 #33F #BB4 #B4B #4BB #A82 #A28 #2A8 #8A2 #28A #82A'.split(' ')
    var omx = Stock('OMX30', '#666', noise([120,120], 60, 5))
    env.symbols.OMX30 = omx

    env.getSymbol = function (id) {
      if (!this.symbols[id]) {
        var data = listSum(omx.data, noise([0,0], 30, 5))
        this.symbols[id] = {name:id, color:_.sample(colors), data:data}
      }
      return this.symbols[id]
    }

    self.app = {
      env: env,
      timeRange: omx.data.length,
      source: localStorage['finscript:lastSource'],
      events: riot.observable(),
      setHoldingCount: function (symbol, count) {
        env.holdings[symbol] = env.getHolding(symbol)
        env.holdings[symbol].count = count
      }
    }

    self.app.events.on('source-changed', src => localStorage['finscript:lastSource'] = src)

  </script>
</dev-env>

<code-editor>

  <div class=row>
    <button onclick={parseSource}>
      <svg width="20px" height="20px" viewBox="0 0 46 46">
        <path transform="translate(-6,4)" d="M40 16h-5.62c-.9-1.56-2.14-2.91-3.63-3.92l3.25-3.25-2.83-2.83-4.35 4.35c-.9-.22-1.85-.35-2.82-.35-.97 0-1.92.13-2.82.35l-4.35-4.35-2.83 2.83 3.25 3.25c-1.49 1.01-2.73 2.36-3.63 3.92h-5.62v4h4.18c-.11.65-.18 1.32-.18 2v2h-4v4h4v2c0 .68.07 1.35.18 2h-4.18v4h5.62c2.07 3.58 5.94 6 10.38 6s8.31-2.42 10.38-6h5.62v-4h-4.18c.11-.65.18-1.32.18-2v-2h4v-4h-4v-2c0-.68-.07-1.35-.18-2h4.18v-4zm-12 16h-8v-4h8v4zm0-8h-8v-4h8v4z" fill="#fff"></path>
      </svg> Compile
    </button>
    <div class=pull-right>
      <button onclick={loadDefault}>Load default</button>
    </div>
  </div>

  <div class="card card-editor">
    <textarea
      class=editor rows=18 ref="editor" value={source}
      onkeyup={sourceChanged}
      autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
    <div class=output>
      <div class="output-info" each={e in infos}>{e}</div>
      <div class="output-error" each={err in errors}>{err}</div>
    </div>
  </div>

  <style>
    .svg-stock-graph { opacity: 0.5; }
    .editor-error {
      position: absolute;
      left: 0;
      width: 10px;
      height: 17px;
      background: rgba(255,0,0,0.3);
    }
    .card-editor {
      display: flex;
    }
    .editor, .CodeMirror {
      display: inline-block;
      position: relative;
      vertical-align: top;
      resize: none;
      outline: none;
      width: 60%;
      font-family: Consolas, Menlo, monospace;
      font-size: 14px;
      line-height: 17px;
      background: none;
      color: #03A678;
      border: 0;
    }
    .output {
      display: inline-block;
      vertical-align: top;
      width: 40%;
      font-family: Consolas, Menlo, monospace;
      font-size: 14px;
      padding: 15px;
      border-radius: 0 4px 4px 0;
      background: #444;
    }
    .output-info {
      color: #49A;
      white-space: pre;
    }
    .output-error {
      color: #A94;
      white-space: pre;
    }
    .syntax-error {
      color: #F00;
    }
    input[type=range] { width: 100% }
  </style>
  <script>
    var self = this

    var app = self.opts.app

    self.infos = []
    self.errors = []
    var errorMarks = []

    function clearErrorMarks() {
      errorMarks.forEach(e => e.clear())
      errorMarks = []
    }

    function error(msg, node) {
      self.errors.push('#' + node.loc[0].first_line + ',' + node.loc[0].first_column + ' ' + msg)
      var mark = self.editor.markText(
        {line: node.loc[0].first_line-1, ch: node.loc[0].first_column},
        {line: node.loc[1].last_line-1, ch: node.loc[1].last_column},
        { css: 'background: #F88' }
      )
      //{ className: 'syntax-error' }
      errorMarks.push(mark)
    }

    self.loadDefault = function () {
      var defaultExample = document.getElementById('example-source').innerHTML.trim()
      app.source = defaultExample
      app.events.trigger('source-changed', defaultExample)
    }

    self.sourceChanged = _.debounce(function (){
      self.parseSource()
      self.update()
    }, 1000)

    self.parseSource = function () {
      self.infos = []
      self.errors = []
      clearErrorMarks()
      var source = self.editor.getValue()
      app.source = source
      var ast = {}
      try {
        ast = finscript.parse(source, error)
        finscript.populateScopes(ast, error)
        finscript.markupTypes(ast, error)
        finscript.checkTypes(ast, error)
      } catch(e) {
        self.errors.push(e.message)
        return
      }
      app.events.trigger('source-changed', source)
      app.events.trigger('ast-changed', ast)
    }

    self.source = app.source

    self.on('mount', function() {
      self.editor = CodeMirror.fromTextArea(self.refs.editor, {
        lineNumbers: true,
        lineWrapping: true,
        mode: 'lua',
        matchBrackets: true,
        theme: 'solarized light',
        keyMap: 'sublime'
      });
      self.editor.on('change', self.sourceChanged)
      self.update()
    })
    
    app.events.on('source-loaded', function (src){
      clearErrorMarks()
      self.editor.setValue(src)
      self.update()
    })

  </script>
</code-editor>

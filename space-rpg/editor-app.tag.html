<editor-app>

  <div class="main-menu">
    <a onclick={toggleFileMenu} class={ 'tab toggle-tab': true, active: isFileMenuOpen }>file</a>
    <a each={e in tabs} href="#{e}" onclick={pageChange} class={tab:true, active: page=='#'+e}>{e}</a>
    <div class="file-tools">
      <label><input type=checkbox ref="useStorageInput" checked={useLocalStorage} onchange={updateAutoSaving}> Use localstorage</label>
      <i>{app.isSaved ? 'Saved' : 'Unsaved'}</i>
      <b>{app.world.name}</b>
    </div>
  </div>

  <galactic-map app={app} if={page == '#map'} />
  <celestials-viewer app={app} if={page == '#celestials'} />
  <models-viewer app={app} if={page == '#models'} />
  <ships-viewer app={app} if={page == '#ships'} />
  <enemies-viewer app={app} if={page == '#enemies'} />
  <items-viewer app={app} if={page == '#items'} />
  <quest-list app={app} if={page == '#quests'} />

  <item-chooser app={app} />
  <ship-chooser app={app} />
  <validation-report app={app} />
  <div class="file-menu-backdrop" if={isFileMenuOpen} onclick={toggleFileMenu}></div>
  <file-menu app={app} if={isFileMenuOpen} />

  <div class="toast">{notification || ''}</div>

  <script>
    var self = this

    self.page = '#map'
    self.tabs = ['map', 'celestials', 'models', 'ships', 'enemies', 'items', 'quests']
    self.isFileMenuOpen = false
    self.useLocalStorage = !! _.jsonParse(localStorage['nebula:use-local-storage'] || 'false')
    self.app = {
      isSaved: false,
      world: self.opts.world,
      events: riot.observable(),
      notify: notify,
      setWorld: setWorld,
      getWorld: () => self.app.world,
      allTags: allTags,
      tagFilter: tagFilter,
      nullWorld: nullWorld,
      celestialTypes: ['cloud', 'star', 'jovian', 'planet', 'asteroid', 'anomaly'],
      audios: [
        'music-final ending',
        'music-ocean',
        'music-sand dark',
        'music-space fight',
        'music-world of hope',
        'music-1997',
        'music-ambient',
        'music-slask'
      ]
    }
    function notify(msg) {
      self.app.events.trigger('notify', msg)
    }
    self.toggleFileMenu = () => self.isFileMenuOpen = ! self.isFileMenuOpen
    self.pageChange = function() {
      self.app.events.trigger('save-entity')
      self.app.events.trigger('save-world')
      self.app.events.trigger('request-validate')
      window.document.body.scrollTop = 0
    }

    self.updateAutoSaving = function () {
      self.useLocalStorage = !!self.refs.useStorageInput.checked
      localStorage['nebula:use-local-storage'] = JSON.stringify(self.useLocalStorage)
      if (self.useLocalStorage) {
        if (localStorage['nebula:world'])
          try {
            setWorld(parseWorld(localStorage['nebula:world']))
          }
          catch(e) {
            alert('locally stored world was corrupt, removing data from localStorage')
            delete localStorage['nebula:world']
            self.useLocalStorage = false
            localStorage['nebula:use-local-storage'] = JSON.stringify(self.useLocalStorage)
            self.update()
          }
      }
    }

    function nullWorld() {
      return {
        name: 'nullworld',
        about: '',
        initialShip: '',
        initialState: 'surface',
        initialDestination: '',
        destinations: [],
        regions: [],
        quests: [],
        items: [],
        ships: [],
        enemies: [],
        celestials: [],
        models: []
      }
    }

    function allTags(items) {
      return _.uniq(_.flatten(items.map(e => (e.tags || '').split(' ')))).sort()
    }

    function tagFilter(items, query) {
      return (query === '' ?
        items.filter(e => !e.tags) :
        (query ? items.filter(e => (e.tags || '').includes(query)) : items))
    }

    function saveWorld() {
      self.app.events.trigger('save-world')
      if (self.useLocalStorage) {
        self.app.isSaved = true
        self.update()
        localStorage['nebula:world'] = _.stringify(self.app.world)
      }
    }

    function setWorld(world) {
      self.app.world = world
      if (self.useLocalStorage)
        localStorage['nebula:world'] = _.stringify(world)
      self.app.isSaved = true
      self.app.events.trigger('world-updated')
      self.update()
    }

    self.app.events.on('notify', function (msg) {
        self.notification = (self.notification ? self.notification + ' ' + msg : msg)
        self.update()
        setTimeout(function(){
          self.notification = ''
          self.update()
        }, 2000)
    })

    self.on('mount', function() {
      function updatePage() {
        self.page = (window.location.hash || '#map')
        self.update()
      }
      window.addEventListener('hashchange', updatePage)
      updatePage()

      window.addEventListener('click', function onUserInteraction() {
        self.app.isSaved = false
      })

      self.app.events.on('request-close-filemenu', () => self.isFileMenuOpen = false)

      window.addEventListener('keydown', function (e) {
        if (e.key == 's' && e.metaKey) {
          self.app.events.trigger('save-entity')
          self.app.events.trigger('notify', 'Saving entity')
          e.preventDefault()
        }
      })

      window.setInterval(function () {
        if (!self.app.isSaved) {
          saveWorld()
          self.app.events.trigger('request-validate')
        } else {
          self.isSaved = true
          self.update()
        }
      }, 2000)
    })

  </script>
  <style>
    .main-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #f8f8f8;
      border-bottom: 1px solid #aaa;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
    }
    i {
      color: #888;
      padding: 0 10px;
    }
    .file-tools {
      float: right;
      margin: 6px 6px 0 0;
    }
    a.toggle-tab {
      width: 20px;
      border-left: 1px solid #f8f8f8;
      border-right: 1px solid #f8f8f8;
    }
    a.tab, a.tab:active, a.tab:hover, a.tab:visited {
      display: inline-block;
      text-decoration: none;
      color: #000;
      padding: 5px 10px;
    }
    a.tab.active {
      background: #ddd;
      border-left: 1px solid #ccc;
      border-right: 1px solid #ccc;
      font-weight: bold;
      box-shadow: 0 3px 6px #ccc inset;
    }
    .file-menu-backdrop {
      z-index: 9;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0);
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 200px;
      padding: 8px;
      background: #2c8;
      color: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      transition: top 0.3s;

    }
    .toast:empty {
      top: -40px;
    }
  </style>

</editor-app>

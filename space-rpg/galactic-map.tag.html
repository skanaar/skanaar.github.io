<galactic-map>

  <svg class="galmap"
      riot-width={2*dx}
      riot-height={2*dy}
      onmousedown={mousedown}
      onmousemove={mousemove}
      onmouseup={mouseup}>
    <line each={x in gridX} stroke="#DDD" stroke-width=0.5 riot-x1={x} riot-x2={x} riot-y1={gridMin.y} riot-y2={gridMax.y} />
    <line each={y in gridY} stroke="#DDD" stroke-width=0.5 riot-x1={gridMin.x} riot-x2={gridMax.x} riot-y1={y} riot-y2={y} />
    <line each={lines}
      stroke-width="2" stroke="#888"
      riot-x1={a.x} riot-x2={b.x} riot-y1={a.y} riot-y2={b.y} />
    <text class="galmap_label" each={nodes} riot-x={screenPos.x+radiusFor(entity.style)+4} riot-y={screenPos.y+7}>
      {entity.name}
    </text>
    <ellipse
      each={nodes}
      stroke-width="2"
      stroke={isSelected ? '#F00' : '#000'}
      fill={isSelected ? '#F88' : fillFor(entity.style)}
      riot-cx={screenPos.x} riot-cy={screenPos.y}
      riot-rx={1+radiusFor(entity.style)} riot-ry={1+radiusFor(entity.style)}
      onmouseup={mouseupOnItem}/>
    <path
      each={enemyDestinations()}
      d="M-2,2 L0,-2 L2,2 Z"
      riot-transform={'translate(' + (screenPos.x+radiusFor(entity.style)+3) + ',' + (screenPos.y-radiusFor(entity.style)-3) + ')'}
      fill="rgba(255,0,0,0.5)" stroke="#F00"/>
    <ellipse
      each={treasureDestinations()}
      riot-cx={screenPos.x+3} riot-cy={screenPos.y+3}
      rx=2 ry=2
      stroke="#000" fill="#FF0" />
    <path
      each={traderDestinations()}
      d="M-6,-4 L-6,4 L0,0 Z"
      riot-transform={'translate(' + (screenPos.x-radiusFor(entity.style)) + ',' + screenPos.y + ')'}
      fill="#0A0" stroke="#FFF"/>
    <rect riot-x={select.pos.x} riot-y={select.pos.y}
      riot-width={select.dim.x} riot-height={select.dim.y}
      stroke="#F00" stroke-width="1" fill="rgba(0,0,0,0)"/>
  </svg>

  <div class="galmap_tools galmap-toolbox">
    <div class="btn-group">
      <a onclick={() => tool='select'} class="toggle-btn {(tool == 'select') && 'active'}">Select
      </a><a onclick={() => tool='draw'} class="toggle-btn {(tool == 'draw') && 'active'}">Draw
      </a><a onclick={() => tool='spray'} class="toggle-btn {(tool == 'spray') && 'active'}">Spray</a>
    </div>
    <div class="btn-group" style="opacity: {selectionSize > 1 ? 1 : 0.5}">
      <a class="toggle-btn" onclick={enlarge}>Enlarge</a><a class="toggle-btn" onclick={shrink}>Shrink</a>
    </div>
    <div class="btn-group" style="opacity: {selectionSize > 1 ? 1 : 0.5}">
      <a class="toggle-btn" onclick={repulse}>Repulse</a><a class="toggle-btn" onclick={attract}>Attract</a>
    </div>
    <button onclick={removeSelected}  style="opacity: {selectionSize > 0 ? 1 : 0.5}">Delete</button>
  </div>

  <div class="galmap_tools galmap-editmenu">
    <button onclick={saveToStorage}>Save</button>
    <button onclick={loadFromStorage}>Load</button>
    <a ref="downloadLink" onmouseenter={primeDownloadLink} download="destinations.json" href='#'>Download</a>
    <br/>
    <input type=file ref=fileInput onchange={fileChanged} style="width: 150px">

    <label>Start World &amp; Ship</label>
    <input ref="initialDestinationInput" type=text value={world.initialDestination}>
    <select ref="initialShipSelect" onchange={setInitialShip}>
      <option each={e in world.ships}>{e}</option>
    </select>

    <label>Name</label>
    <input type=text ref="nameField" placeholder="name">
    <button onclick={setName}>OK</button>
    <button onclick={autoNameNodes}>Autoname</button>

    <label>Celestial &amp; Surface</label>
    <select ref="styleSelect" onchange={setCelestialStyle}>
      <option value="unknown">- style -</option>
      <option each={e in world.celestialStyles}>{e.id}</option>
    </select>
    <button onclick={randomizeStyle}>Randomize</button>
    <select ref="surfaceSelect" onchange={setSurface}>
      <option value="unknown">- surface -</option>
      <option each={e in world.surfaces}>{e.id}</option>
    </select>

    <label>Treasures</label>
    <select onchange={pickTreasureItem}>
      <option each={e in world.items} value={e.name}>{e.name} ({e.credits} c)</option>
    </select>
    <span>{selectedTreasures}</span>
    <button onClick={clearTreasures}>&times;</button>

    <div show={selectionSize == 1}>
      <label><input type=checkbox ref=traderToggle onchange={traderChange}> Trader - Buy &amp; Sell</label>
      <select onchange={pickTraderItem}>
        <option each={e in world.items} value={e.name}>{e.name} ({e.credits} c)</option>
      </select>
      <input type=text value={selectedTrader.buy} onchange={traderBuyChange}>
      <input type=text value={selectedTrader.sell} onchange={traderSellChange}>
      <span>{(selectedTrader.inventory || []).join(', ')}</span>
      <button onClick={clearInventory}>&times;</button>

      <label><input type=checkbox ref=enemyToggle> Enemy</label>
      <select>
        <option each={e in world.enemies}>{e}</option>
      </select>

      <label>Loot</label>
      <input type=text placeholder=Loot>
    </div>
  </div>

  <script>
    var self = this

    self.nodes = []
    self.lines = []
    self.jumpRange = 125
    self.scale = (+ location.search.substring(1).split('=')[1]) || 0.5
    self.tool = 'select' // draw | spray
    self.dx = window.innerWidth
    self.dy = window.innerWidth
    self.gridMin = transform({x:-self.dx/self.scale,y:-self.dy/self.scale})
    self.gridMax = transform({x: self.dx/self.scale,y: self.dy/self.scale})
    self.gridX = _.range(self.gridMin.x, self.gridMax.x, self.scale*50)
    self.gridY = _.range(self.gridMin.y, self.gridMax.y, self.scale*50)
    self.input = { a: Vec(0,0), b: Vec(0,0) }
    self.isDown = false
    self.select = { pos: Vec(0,0), dim: Vec(0,0) }
    self.world = {
      ships: [],
      enemies: [],
      initialDestination: '',
      initialShip: 'clipper',
      celestialStyles: [],
      destinations: []
    }
    self.selectionSize = 0
    self.selectedTreasures = ''
    self.selectedTrader = { inventory: [] }

    self.setTool = function (id) { self.tool = id }

    self.removeSelected = function () {
      self.nodes = self.nodes.filter(e => !e.isSelected)
      updateUI()
      calculateLines()
    }

    self.keydown = function (e) {
      if (document.activeElement && document.activeElement.nodeName === 'INPUT') return;
      var step = e.shiftKey ? 2 : (e.metaKey ? 100 : 20)
      switch (e.key) {
        case 'Backspace':
        case 'Delete':     self.removeSelected(); break;
        case 'ArrowLeft':  translateSelection(Vec(-step, 0)); break;
        case 'ArrowRight': translateSelection(Vec(step, 0)); break;
        case 'ArrowUp':    translateSelection(Vec(0, -step)); break;
        case 'ArrowDown':  translateSelection(Vec(0, step)); break;
        default: return;
      }
      e.preventDefault()
    }

    function translateSelection(delta) {
      _.filter(self.nodes, 'isSelected').forEach(function (node) {
        node.entity.pos = add(node.entity.pos, delta)
        node.screenPos = transform(node.entity.pos)
      })
      calculateLines()
      self.update()
    }

    self.mousedown = function (e) { // 132
      e.preventDefault()
      self.input.a = Vec(e.offsetX, e.offsetY)
      self.isDown = true
    }
    self.mousemove = function (e) {
      e.preventDefault()
      if (!self.isDown) return;
      self.input.b = Vec(e.offsetX, e.offsetY)
      var d = diff(self.input.b, self.input.a)
      self.select.dim = Vec(Math.abs(d.x), Math.abs(d.y))
      self.select.pos = Vec(Math.min(self.input.a.x, self.input.b.x), Math.min(self.input.a.y, self.input.b.y))
    }
    self.mouseupOnItem = function (e) {
      e.stopPropagation()
      if (e.shiftKey) {
        e.item.isSelected = !e.item.isSelected
      }
      else {
        self.nodes.forEach(function (e){ e.isSelected = false })
        e.item.isSelected = true
      }
      updateUI()
      self.isDown = false
      self.select = { pos: Vec(0,0), dim: Vec(0,0) }
      self.input.a = Vec(0,0)
      self.input.b = Vec(0,0)
    }

    function addAsteroid(pos) {
        self.nodes.push({
          screenPos: transform(pos),
          isSelected: false,
          entity: {
            pos: pos,
            name: 'unnamed',
            style: 'asteroid-1',
            surface: 'rock-1',
            trader: null,
            enemy: null
          }
        })
    }

    self.mouseup = function (e) {
      e.preventDefault()
      document.activeElement.blur()
      self.input.b = Vec(e.offsetX, e.offsetY)
      if (0 == dist(self.input.a, self.input.b) && self.tool != 'select') {
        var pos = mult(diff(self.input.a, Vec(self.dx, self.dy)), 1/self.scale)
        if (self.tool == 'draw')
          addAsteroid(pos)
        else if (self.tool == 'spray'){
          for (var i = 0, a = 0; i < 10; i++, a=6.28*Math.random()){
            var delta = mult(Vec(Math.cos(6.28*i/10), Math.sin(6.28*i/10)), 80)
            addAsteroid(add(pos, add(delta, Vec(60*Math.random(), 60*Math.random()))))
          }
        }
        calculateLines()
      } else {
        self.nodes.forEach(function (e) {
          var p = transform(e.entity.pos)
          e.isSelected = (
            p.x > self.select.pos.x &&
            p.y > self.select.pos.y &&
            p.x < self.select.pos.x + self.select.dim.x &&
            p.y < self.select.pos.y + self.select.dim.y)
            updateUI()
        })
      }
      self.isDown = false
      self.select = { pos: Vec(0,0), dim: Vec(0,0) }
      self.input.a = Vec(0,0)
      self.input.b = Vec(0,0)
    }

    function serializedWorld() {
      self.world.destinations = self.nodes.map(e => e.entity)
      return _.stringify(self.world, {maxLength: 200})
    }

    self.primeDownloadLink = function () {
      var serialization = encodeURIComponent(serializedWorld())
      self.refs.downloadLink.setAttribute('href', 'data:text;charset=utf-8,' + serialization)
    }

    self.saveToStorage = function () {
      localStorage['world'] = serializedWorld()
    }

    self.loadFromStorage = function () {
      loadWorld(localStorage['world'])
    }

    self.autoNameNodes = function () {
      var abs = Math.abs
      self.nodes
        .filter(e => e.isSelected)
        .forEach(function (node){
          var e = node.entity
          if (e.style.startsWith('asteroid'))
            e.name = 'A'+abs(e.pos.x%100)+abs(e.pos.y%100)
          if (e.style == 'anomaly-buoy') 
            e.name = 'Buoy '+(1+abs(e.pos.x)%10)+(1+abs(e.pos.y)%100)
        })
    }

    self.setCelestialStyle = function (e) {
      self.nodes.forEach(function (node) {
        if (node.isSelected) node.entity.style = e.target.value
      })
      self.update()
      calculateLines()
    }

    self.setSurface = function (e) {
      self.nodes.forEach(function (node) {
        if (node.isSelected) node.entity.surface = e.target.value
      })
      self.update()
    }

    function toggleItemInSet(set, item) {
      var index = set.indexOf(item)
      if (index != -1) set.splice(index, 1)
      else set.push(item)
    }

    function forSelection(action) {
      _.filter(self.nodes, 'isSelected').forEach(action)
      updateUI()
    }

    self.pickTreasureItem = function (e) {
      forSelection(function (node) {
        if (!node.entity.treasures) node.entity.treasures = []
        toggleItemInSet(node.entity.treasures, e.target.value)
      })
    }

    self.clearTreasures = function (e) {
      forSelection(node => node.entity.treasures = [])
    }

    self.traderChange = function (e) {
      forSelection(function (node) {
        node.entity.trader = e.target.checked ? { buy: 0.75, sell: 1.5, inventory: [] } : null
      })
    }

    self.pickTraderItem = function (e) {
      forSelection(node => toggleItemInSet(node.entity.trader.inventory, e.target.value))
    }

    self.traderBuyChange = function (e) {
      forSelection(node => node.entity.trader.buy = e.target.value)
    }

    self.traderSellChange = function (e) {
      forSelection(node => node.entity.trader.sell = e.target.value)
    }

    self.clearInventory = function (e) {
      forSelection(node => node.entity.trader.inventory = [])
    }

    self.setInitialShip = function (e) {
      self.world.initialShip = e.target.value
      self.update()
    }

    self.setName = function (e) {
      var selection = _.filter(self.nodes, 'isSelected')
      if (selection.length == 1) selection[0].entity.name = self.refs.nameField.value
    }

    self.randomizeStyle = function () {
      _.filter(self.nodes, 'isSelected').forEach(function (node) {
        var type = node.entity.style.split('-')[0]
        var stylesOfSameType = self.world.celestialStyles.filter(function(e){return e.startsWith(type)})
        node.entity.style = _.sample(stylesOfSameType)
      })
      updateUI()
      calculateLines()
    }

    self.fileChanged = function () {
      var reader = new FileReader()
      reader.onload = () => loadWorld(reader.result)
      reader.readAsText(self.refs.fileInput.files[0])
    }

    self.repulse = function () { self.repulseAttract(1) }
    self.attract = function () { self.repulseAttract(-1) }
    self.repulseAttract = function (coefficient) {
      var subset = _.filter(self.nodes, 'isSelected')
      subset.forEach(function (a) {
        subset.forEach(function (b){
          if (eq(a.entity.pos, b.entity.pos)) return
          var delta = diff(a.entity.pos, b.entity.pos)
          var d = normalize(delta)
          var force = coefficient * 5000 / Math.max(1000, delta.x*delta.x + delta.y*delta.y)
          a.entity.pos = rund(add(a.entity.pos, mult(d, force)))
          b.entity.pos = rund(add(b.entity.pos, mult(d, -force)))
          a.screenPos = transform(a.entity.pos)
          b.screenPos = transform(b.entity.pos)
        })
      })
      calculateLines()
    }
    self.enlarge = function () { self.enlargeShrink(1.01) }
    self.shrink = function () { self.enlargeShrink(0.99) }
    self.enlargeShrink = function (coefficient) {
      var subset = _.filter(self.nodes, 'isSelected')
      var positions = subset.map(e => e.entity.pos)
      var centroid = mult(positions.reduce(add, Vec(0,0)), 1/subset.length)
      subset.forEach(function (a) {
        a.entity.pos = rund(add(centroid, mult(diff(a.entity.pos, centroid), coefficient)))
        a.screenPos = transform(a.entity.pos)
      })
      calculateLines()
    }

    self.enemyDestinations = () => self.nodes.filter(e => e.entity.enemy)
    self.traderDestinations = () => self.nodes.filter(e => e.entity.trader)
    self.treasureDestinations = () => self.nodes.filter(e => (e.entity.treasures || []).length)

    var fills = {
      cloud: '#D8D', star: '#ff4', jovian: '#fa8', planet: '#8f8', asteroid: '#aaa', anomaly: '#fa0', ring: '#8af'
    }
    self.fillFor = function (style) {
      return fills[style.split('-')[0]]
    }

    self.radiusFor = function (style) {
      return self.world.celestialStyles.find(function (e){ return e.id == style }).r * self.scale
    }

    function uniqueSelectedProp(key) {
      var x = null
      self.nodes.forEach(function (e) {
        if (e.isSelected && e.entity[key])
          x = x == null ? e.entity[key] : (e.entity[key] == x ? e.entity[key] : 'unknown')
      })
      return x
    }

    function updateUI() {
      self.refs.styleSelect.value = uniqueSelectedProp('style') || 'unknown'
      self.refs.surfaceSelect.value = uniqueSelectedProp('surface') || 'unknown'
      self.refs.initialShipSelect.value = self.world.initialShip
      var selection = _.filter(self.nodes, 'isSelected')
      self.refs.nameField.value = selection.length == 1 ? selection[0].entity.name : ''
      self.refs.traderToggle.checked = !!(selection.length == 1 && selection[0].entity.trader)
      self.selectionSize = selection.length
      var selectedTreasures = selection.map(e => e.entity.treasures || [])
      self.selectedTreasures = _.flatten(selectedTreasures).join(', ')
      self.selectedTrader = (selection[0] && selection[0].entity.trader) || { buy: 0, sell: 0, inventory: [] }
    }

    function transform(p) { return Vec(self.dx+self.scale*p.x, self.dy+self.scale*p.y) }

    function loadWorld(data) {
        self.world = JSON.parse(data)
        loadDestinations(self.world)
        updateUI()
        self.update()
    }

    function loadDestinations(world) {
      self.nodes = world.destinations.map(function (e) {
        return {
          screenPos: transform(e.pos),
          isSelected: false,
          fill: fills[e.style.split('-')[0]],
          r: world.celestialStyles.find(function (sty){ return sty.id == e.style }).r,
          entity: e
        }
      })
      calculateLines()
    }

    function calculateLines() {
      self.lines = []
      self.nodes.forEach(function (a) {
        self.nodes.forEach(function (b){
          if (self.jumpRange > dist(a.entity.pos, b.entity.pos) && isTravellable(a.entity) && isTravellable(b.entity))
            self.lines.push({ a: transform(a.entity.pos), b: transform(b.entity.pos) })
        })
      })
    }

    function isTravellable(entity) {
      return !entity.style.startsWith('cloud') && !entity.style.startsWith('star')
    }

    self.on('mount', function() {
      window.document.addEventListener('keydown', self.keydown.bind(self))
      _.fetch('world.json', function (data) {
        loadWorld(data)
      })
      window.scrollTo(self.dx/3, self.dy/3)
    })

    function Vec(x,y){ return {x:x, y:y} }
    function dist(a,b){ return mag(diff(a,b)) }
    function eq(a,b){ return Math.abs(a.x-b.x) < 1 && Math.abs(a.y-b.y) < 1 }
    function rund(a){ return Vec(Math.round(a.x), Math.round(a.y)) }
    function add(a,b){ return { x: a.x + b.x, y: a.y + b.y } }
    function diff(a,b){ return { x: a.x - b.x, y: a.y - b.y } }
    function mult(v,factor){ return { x: factor*v.x, y: factor*v.y } }
    function mag(v){ return Math.sqrt(v.x*v.x + v.y*v.y) }
    function normalize(v){ return mult(v, 1/mag(v)) }
    function rot(a){ return { x: a.y, y: -a.x } }

  </script>

  <style>
    :scope {
      font-family: "helvetica neue", "arial", sans-serif;
    }
    hr {
      border: none;
      height: 1px;
      background: #aaa;
    }
    .galmap_tools {
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .galmap_tools.galmap-editmenu {
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      padding: 5px;
      background: #fafafa;
      border-left: 1px solid #aaa;
      text-align: right;
    }
    .galmap_tools.galmap-filemenu {
      position: fixed;
      left: 10px;
      top: 10px;
      text-align: left;
    }
    .galmap_tools.galmap-toolbox {
      position: fixed;
      left: 10px;
      right: 10px;
      top: 10px;
      text-align: center;
    }
    .galmap_tools span {
      display: block;
      max-width: 150px;
      text-align: left;
    }
    .galmap_tools label {
      display: block;
      text-align: left;
      font-weight: bold;
      margin-top: 20px;
      padding: 2px;
      margin-bottom: 5px;
      border-bottom: 1px solid #ddd;
    }
    .galmap_tools.galmap-editmenu input[type=text],
    .galmap_tools.galmap-editmenu input[type=file],
    .galmap_tools.galmap-editmenu select {
      display: block;
      margin: 2px 0;
      width: 150px;
    }
    .galmap_label {
      font-size: 8px;
      font-family: Verdana;
      fill: rgba(0,0,0,0.4);
    }
    .galmap_label:hover {
      fill: #000;
    }
    .galmap_tools > div {
      margin: 3px 0;
    }
    .galmap_tools a,
    .galmap_tools button,
    .galmap_tools input[type=file],
    .galmap_tools input[type=text] {
      display: inline-block;
      margin: 0 0 0 5px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 1px 8px;
      border-radius: 4px;
      color: #000;
      text-decoration: none;
      box-shadow: 0 1px 0px rgba(0,0,0,0.05);
      font-size: 11px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .galmap_tools input[type=text] {
      border: 1px solid #aaa;
      border-radius: 2px;
    }
    .galmap_tools button:active {
      background: linear-gradient(to top, #07f, #5af);
      border-color: #25f;
    }
    .galmap_tools .btn-group {
      display: inline-block;
      margin: 0 5px;
    }
    .btn-group .toggle-btn {
      border-radius: 0;
      margin: 0 0 0 -1px;
      cursor: pointer;
      user-select: none;
    }
    .btn-group .toggle-btn:hover {
      background: linear-gradient(to top, #8bf, #adf);
      border-color: #8af;
    }
    .btn-group .toggle-btn:first-child { border-radius: 4px 0 0 4px }
    .btn-group .toggle-btn:last-child { border-radius: 0 4px 4px 0 }
    .btn-group .toggle-btn.active {
      background: linear-gradient(to top, #07f, #5af);
      border-color: #25f;
    }
  </style>

</galactic-map>

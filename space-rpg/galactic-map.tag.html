<galactic-map>

  <svg class="galmap" onmousedown={mousedown} onmousemove={mousemove} onmouseup={mouseup} width={2*dx} height={2*dy}>
    <line each={x in gridX} stroke="#DDD" stroke-width=0.5 riot-x1={x} riot-x2={x} riot-y1={gridMin.y} riot-y2={gridMax.y} />
    <line each={y in gridY} stroke="#DDD" stroke-width=0.5 riot-x1={gridMin.x} riot-x2={gridMax.x} riot-y1={y} riot-y2={y} />
    <path each={q in quests} 
      stroke="#48F"
      stroke-width="1"
      fill="none"
      stroke-dasharray="5,5"
      transform="translate(0,5)"
      d={q}></path>
    <line each={lines}
      stroke-width="2" stroke="#048"
      riot-x1={a.x} riot-x2={b.x} riot-y1={a.y} riot-y2={b.y} />
    <ellipse
      each={items}
      stroke-width="2"
      stroke={isSelected ? '#F00' : '#000'}
      fill={fillFor(entity.style)}
      riot-cx={screenPos.x} riot-cy={screenPos.y}
      riot-rx={radiusFor(entity.style)} riot-ry={radiusFor(entity.style)}
      onmouseup={mouseupOnItem}/>
    <text class="galmap_label" each={items} riot-x={screenPos.x+10} riot-y={screenPos.y+7}>
      {entity.name}
    </text>
    <rect riot-x={select.pos.x} riot-y={select.pos.y}
      riot-width={select.dim.x} riot-height={select.dim.y}
      stroke="#F00" stroke-width="1" fill="rgba(0,0,0,0)"/>
  </svg>
  <div class="galmap_tools">
    <div>
      <a ref="load" onclick={openFile} href='#'>Load</a>
      <a ref="save" onmouseenter={primeDownloadLink} download="destinations.json" href='#'>Save</a>
    </div>
    <div>
      <select ref="styleSelect" onchange={setCelestialStyle}>
        <option value="unknown">- style -</option>
        <option each={e,i in celestialStyles}>{e}</option>
      </select>
      <button onclick={randomizeStyle}>Randomize</button>
    </div>  
    <div>
      <input type=text ref="nameField" placeholder="name"> <button onclick={setName}>OK</button>
      <button onclick={autoNameNodes}>Autoname</button>
    </div>
    <div><button onclick={removeSelected}>Delete</button></div>
  </div>
  <script>
    var self = this

    self.items = []
    self.quests = []
    self.lines = []
    self.jumpRange = 125
    self.scale = 0.5
    self.dx = window.innerWidth
    self.dy = window.innerWidth
    self.gridMin = transform({x:-self.dx/self.scale,y:-self.dy/self.scale})
    self.gridMax = transform({x: self.dx/self.scale,y: self.dy/self.scale})
    self.gridX = _.range(self.gridMin.x, self.gridMax.x, self.scale*50)
    self.gridY = _.range(self.gridMin.y, self.gridMax.y, self.scale*50)
    self.input = { a: Vec(0,0), b: Vec(0,0) }
    self.isDown = false
    self.select = { pos: Vec(0,0), dim: Vec(0,0) }
    self.celestialStyles = [
      'planet-green-1','planet-green-2','planet-green-3','planet-water-1','planet-water-2',
      'planet-water-3','planet-badlands-1','planet-rock-1','planet-hell-1','planet-hell-2',
      'planet-hell-3','planet-hell-4','planet-hell-5','planet-star-m-ff0','planet-neutron-1',
      'planet-neutron-2','planet-neutron-3','asteroid-1','asteroid-2','asteroid-3','asteroid-4',
      'asteroid-5','asteroid-6','asteroid-7','cloud-orange','cloud-green','cloud-purple',
      'cloud-star-yellow','ring-1','ring-2','ring-3','ring-4','anomaly-buoy','anomaly-derelict'
    ]

    self.removeSelected = function () {
      self.items = self.items.filter(function (item){ return !item.isSelected })
      updateUI()
      calculateLines()
    }

    self.keydown = function (e) {
      if (!['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) return
      e.preventDefault()
      var step = e.shiftKey ? 2 : (e.metaKey ? 100 : 20)
      _.filter(self.items, 'isSelected').forEach(function (item) {
        switch (e.key) {
          case 'ArrowLeft': item.entity.pos.x -= step; break;
          case 'ArrowRight': item.entity.pos.x += step; break;
          case 'ArrowUp': item.entity.pos.y -= step; break;
          case 'ArrowDown': item.entity.pos.y += step; break;
        }
        item.screenPos = transform(item.entity.pos)
      })
      calculateLines()
      self.update()
    }

    self.mousedown = function (e) {
      e.preventDefault()
      self.input.a = Vec(e.offsetX, e.offsetY)
      self.isDown = true
    }
    self.mousemove = function (e) {
      e.preventDefault()
      if (!self.isDown) return;
      self.input.b = Vec(e.offsetX, e.offsetY)
      var d = diff(self.input.b, self.input.a)
      self.select.dim = Vec(Math.abs(d.x), Math.abs(d.y))
      self.select.pos = Vec(Math.min(self.input.a.x, self.input.b.x), Math.min(self.input.a.y, self.input.b.y))
    }
    self.mouseupOnItem = function (e) {
      e.stopPropagation()
      if (e.shiftKey) {
        e.item.isSelected = !e.item.isSelected
      }
      else {
        self.items.forEach(function (e){ e.isSelected = false })
        e.item.isSelected = true
      }
      updateUI()
      self.isDown = false
      self.select = { pos: Vec(0,0), dim: Vec(0,0) }
      self.input.a = Vec(0,0)
      self.input.b = Vec(0,0)
    }
    self.mouseup = function (e) {
      e.preventDefault()
      self.input.b = Vec(e.offsetX, e.offsetY)
      if (0 == dist(self.input.a, self.input.b)) {
        var pos = mult(diff(self.input.a, Vec(self.dx, self.dy)), 1/self.scale)
        self.items.push({
          screenPos: transform(pos),
          isSelected: false,
          entity: {
            pos: pos,
            name: 'unnamed',
            style: 'asteroid-1',
            surface: 'rock-1',
            trader: null,
            enemy: null
          }
        })
        calculateLines()
      } else {
        self.items.forEach(function (e) {
          var p = transform(e.entity.pos)
          e.isSelected = (
            p.x > self.select.pos.x &&
            p.y > self.select.pos.y &&
            p.x < self.select.pos.x + self.select.dim.x &&
            p.y < self.select.pos.y + self.select.dim.y)
            updateUI()
        })
      }
      self.isDown = false
      self.select = { pos: Vec(0,0), dim: Vec(0,0) }
      self.input.a = Vec(0,0)
      self.input.b = Vec(0,0)
    }

    self.primeDownloadLink = function () {
      var payload = self.items.map(function (e){ return e.entity })
      var serialization = encodeURIComponent(JSON.stringify(payload, null, 2))
      self.refs.save.setAttribute('href', 'data:text;charset=utf-8,' + serialization)
    }

    self.autoNameNodes = function () {
      var abs = Math.abs
      self.items
        .filter(function (e){ return e.isSelected })
        .forEach(function (item){
          var e = item.entity
          if (e.style.startsWith('asteroid'))
            e.name = 'A'+abs(e.pos.x%100)+abs(e.pos.y%100)
          if (e.style == 'anomaly-buoy') 
            e.name = 'Buoy '+(1+abs(e.pos.x)%10)+(1+abs(e.pos.y)%100)
        })
    }

    self.setCelestialStyle = function (e) {
      self.items.forEach(function (item) {
        if (item.isSelected) item.entity.style = e.target.value
      })
      self.update()
      calculateLines()
    }

    self.setName = function (e) {
      var selection = _.filter(self.items, 'isSelected')
      if (selection.length == 1) selection[0].entity.name = self.refs.nameField.value
    }

    self.randomizeStyle = function () {
      _.filter(self.items, 'isSelected').forEach(function (item) {
        var type = item.entity.style.split('-')[0]
        var stylesOfSameType = self.celestialStyles.filter(function(e){return e.startsWith(type)})
        item.entity.style = _.sample(stylesOfSameType)
      })
      updateUI()
      calculateLines()
    }

    var fills = { planet: '#fff', asteroid: '#888', anomaly: '#fa0', ring: '#00f', cloud: '#DD0' }
    self.fillFor = function (style) {
      return fills[style.split('-')[0]]
    }
    
    var sizes = { planet: 5, asteroid: 3, anomaly: 3, ring: 7, cloud: 15 }
    self.radiusFor = function (style) {
      return sizes[style.split('-')[0]]
    }

    function uniqueSelectedProp(key) {
      var x = null
      self.items.forEach(function (e) {
        if (e.isSelected && e.entity[key])
          x = x == null ? e.entity[key] : (e.entity[key] == x ? e.entity[key] : 'unknown')
      })
      return x
    }

    function updateUI() {
      self.refs.styleSelect.value = uniqueSelectedProp('style') || 'unknown'
      var selection = _.filter(self.items, 'isSelected')
      self.refs.nameField.value = selection.length == 1 ? selection[0].entity.name : ''
    }

    function transform(p) { return Vec(self.dx+self.scale*p.x, self.dy+self.scale*p.y) }

    function loadDestinations(data) {
      var destinations = JSON.parse(data)
      self.items = destinations.map(function (e) {
        return {
          screenPos: transform(e.pos),
          isSelected: false,
          fill:fills[e.style.split('-')[0]],
          r: sizes[e.style.split('-')[0]],
          entity: e
        }
      })
      calculateLines()
      self.update()
    }

    function calculateLines() {
      self.lines = []
      self.items.forEach(function (a) {
        self.items.forEach(function (b){
          if (self.jumpRange > dist(a.entity.pos, b.entity.pos) && !a.entity.style.startsWith('cloud') && !b.entity.style.startsWith('cloud'))
            self.lines.push({ a: transform(a.entity.pos), b: transform(b.entity.pos) })
        })
      })
    }

    function loadQuest(domNode) {
      var destIds = _.map(domNode.childNodes, function (e){
        if (e.nodeName == 'condition')
          return e.getAttribute('at-dest') || e.getAttribute('no-enemy-at')
        if (e.nodeName == 'place-item')
          return e.getAttribute('dest')
        return null
      })
      function findByName(dest) { return _.findWhere(self.items, { name: dest }) }
      return _.compact(_.map(destIds, findByName))
    }

    function loadQuests(data) {
      var dom = (new DOMParser()).parseFromString(data, 'text/xml')
      var questLines = _.filter(_.map(dom.getElementsByTagName('quest'), loadQuest), 'length')
      self.quests = questLines.map(function (quest) {
        return 'M' + quest.map(function (e) { return (e.screenPos.x + ' ' + e.screenPos.y) }).join(' L')
      })
      self.update()
    }

    self.on('mount', function() {
      window.document.addEventListener('keydown', self.keydown.bind(self))
      _.fetch('destinations.json', function (data) {
        loadDestinations(data)
        _.fetch('quests.xml', function (data) { loadQuests(data) })
      })
    })

    function Vec(x,y){ return {x:x, y:y} }
    function dist(a,b){ return mag(diff(a,b)) }
    function add(a,b){ return { x: a.x + b.x, y: a.y + b.y } }
    function diff(a,b){ return { x: a.x - b.x, y: a.y - b.y } }
    function mult(v,factor){ return { x: factor*v.x, y: factor*v.y } }
    function mag(v){ return Math.sqrt(v.x*v.x + v.y*v.y) }
    function normalize(v){ mult(v, 1/mag(v)) }
    function rot(a){ return { x: a.y, y: -a.x } }

  </script>

  <style>
    :scope {
      font-family: "helvetica neue", "arial", sans-serif;
    }
    .galmap_label {
      font-size: 8px;
      font-family: Verdana;
      fill: rgba(0,0,0,0.2);
    }
    .galmap_label:hover {
      fill: #000;
    }
    .galmap_tools {
      position: fixed;
      right: 10px;
      top: 10px;
      text-align: right;
    }
    .galmap_tools a {
      display: inline-block;
      margin: 0 0 0 5px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 1px 8px;
      border-radius: 4px;
      color: #000;
      text-decoration: none;
      font-size: 11px;
      box-shadow: 0 1px 0px rgba(0,0,0,0.05);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
  </style>

</galactic-map>

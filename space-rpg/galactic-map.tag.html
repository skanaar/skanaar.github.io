<galactic-map>

  <svg class="galmap">
    <line each={x in grid} stroke="#222" riot-x1={x} riot-x2={x} riot-y1={gridMin} riot-y2={gridMax} />
    <line each={y in grid} stroke="#222" riot-x1={gridMin} riot-x2={gridMax} riot-y1={y} riot-y2={y} />
    <path each={q in quests} 
      stroke="#FFF"
      stroke-width="1"
      fill="none"
      stroke-dasharray="5,5"
      transform="translate(0,5)"
      d={q}></path>
    <line each={lines}
      stroke-width="2" stroke="#048"
      riot-x1={a.x} riot-x2={b.x} riot-y1={a.y} riot-y2={b.y} />
    <ellipse
      each={items}
      stroke-width="2"
      stroke="#000"
      fill={fill} riot-cx={pos.x} riot-cy={pos.y} riot-rx={r} riot-ry={r} />
    <text class="galmap_label" each={items} riot-x={pos.x+10} riot-y={pos.y+7}>
      {name} {pos.x},{pos.y}
    </text>
  </svg>

  <script>
    var self = this

    self.items = []
    self.quests = []
    self.lines = []
    self.jumpRange = 100
    self.scale = 1.5
    self.dx = 500
    self.dy = 500
    self.gridMin = transform([-300,0]).x
    self.gridMax = transform([300,0]).x
    self.grid = _.range(self.gridMin, self.gridMax, self.scale*50)

    function transform(p) { return { x: self.dx+self.scale*p[0], y: self.dy+p[1]} }
    function dist(a, b) {
      var dx = a[0] - b[0]
      var dy = a[1] - b[1]
      return Math.sqrt(dx*dx + dy*dy)
    }

    var fills = { planet: '#fff', asteroid: '#888', bouy: '#fa0', ring: '#00f', cloud: '#440' }
    var sizes = { planet: 5, asteroid: 3, bouy: 3, ring: 7, cloud: 15 }

    function loadDestinations(data) {
      var destinations = JSON.parse(data)
      self.items = destinations.map(e => (
        {pos: transform(e.pos), name: e.name, fill:fills[e.visual], r: sizes[e.visual] }
      ))
      self.lines = []
      destinations.forEach(a => destinations.forEach(function (b){
        if (self.jumpRange > dist(a.pos, b.pos))
          self.lines.push({ a: transform(a.pos), b: transform(b.pos) })
      }))
      self.update()
    }

    function loadQuest(domNode) {
      var destIds = _.map(domNode.childNodes, function (e){
        if (e.nodeName == 'condition')
          return e.getAttribute('at-dest') || e.getAttribute('no-enemy-at')
        if (e.nodeName == 'place-item')
          return e.getAttribute('dest')
        return null
      })
      return _.map(destIds, dest => _.findWhere(self.items, { name: dest })).filter(e => !!e)
    }

    function loadQuests(data) {
      var dom = (new DOMParser()).parseFromString(data, 'text/xml')
      var questLines = _.map(dom.getElementsByTagName('quest'), loadQuest).filter(e => e.length)
      self.quests = questLines.map(quest => 'M' + quest.map(e => e.pos.x + ' ' + e.pos.y).join(' L'))
      self.update()
    }

    self.on('mount', function() {
      get('destinations.json').then(function (data) {
        loadDestinations(data)
        get('quests.xml').then(data => loadQuests(data, self.destinations))
      })
    })

    function get(url) {
      return fetch(url).then(e => e.text())
    }
  </script>

  <style>
    :scope {
      display: block;
      height: 100vh;
      overflow: hidden;
      color: white;
      font-family: "helvetica neue", "arial", sans-serif;
    }
    .galmap {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .galmap_label {
      fill: rgba(1,1,1,0);
    }
    .galmap_label:hover {
      fill: #fff;
    }
  </style>

</galactic-map>

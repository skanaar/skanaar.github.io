<items-viewer>

  <table class="table">
    <thead>
      <tr>
        <th>name</th>
        <th>credits</th>
        <th>installable</th>
        <th>passive</th>
        <th>maxhull</th>
        <th>maxshield</th>
        <th>maxenergy</th>
        <th>player-hull</th>
        <th>player-shield</th>
        <th>player-energy</th>
        <th>target-hull</th>
        <th>target-shield</th>
        <th>target-energy</th>
      </tr>
    </thead>
    <tbody>
      <tr each={item in world.items} onclick={editItem}>
        <td>{item.name}</td>
        <td>{item.credits}</td>
        <td>{item.isInstallable ? '×' : ''}</td>
        <td>{item.isPassive ? '×' : ''}</td>
        <td>{item.attr.maxhull}</td>
        <td>{item.attr.maxshield}</td>
        <td>{item.attr.maxenergy}</td>
        <td>{item.playerBuff.hull}</td>
        <td>{item.playerBuff.shield}</td>
        <td>{item.playerBuff.energy}</td>
        <td>{item.targetBuff.hull}</td>
        <td>{item.targetBuff.shield}</td>
        <td>{item.targetBuff.energy}</td>
      </tr>
      <tr>
        <td colspan=13><button onclick={add}>+ Add Item</button></td>
      </tr>
    </tbody>
  </table>

  <div class="sidebar" show={!!selected}>
    <input type=text ref="nameField" value={selected && selected.name}>
    <div class="input-grid">
      <em>credits</em>     <input type=number ref="creditsField" value={selected && selected.credits}><br/>
      <em>installable</em> <input type=checkbox ref="isInstallableToggle" checked={selected && selected.isInstallable}><br/>
      <em>passive</em>     <input type=checkbox ref="isPassiveToggle" checked={selected && selected.isPassive}>
    </div>
    
    <label>Attributes</label>
    <div class="input-grid">
      <em>maxhull</em>   <input type=number ref="maxhullField" value={selected && selected.attr.maxhull}><br/>
      <em>maxshield</em> <input type=number ref="maxshieldField" value={selected && selected.attr.maxshield}><br/>
      <em>maxenergy</em> <input type=number ref="maxenergyField" value={selected && selected.attr.maxenergy}><br/>
    </div>
    
    <label>User effect on use</label>
    <div class="input-grid">
      <em>hull</em>   <input type=number ref="playerHullField" value={selected && selected.playerBuff.hull}><br/>
      <em>shield</em> <input type=number ref="playerShieldField" value={selected && selected.playerBuff.shield}><br/>
      <em>energy</em> <input type=number ref="playerEnergyField" value={selected && selected.playerBuff.energy}>
    </div>
    
    <label>Target effect on use</label>
    <div class="input-grid">
      <em>hull</em>   <input type=number ref="targetHullField" value={selected && selected.targetBuff.hull}><br/>
      <em>shield</em> <input type=number ref="targetShieldField" value={selected && selected.targetBuff.shield}><br/>
      <em>energy</em> <input type=number ref="targetEnergyField" value={selected && selected.targetBuff.energy}>
    </div>

    <br/>
    <button onclick={remove}>Delete</button>
    <button onclick={endEditing}>Done</button>
    <button onclick={cancelEditing}>Cancel</button>
  </div>

  <script>
    var self = this

    self.world = { items: [] }
    self.selected = null

    self.add = function () {
      self.world.items.push({
        type:'common', size: 's', isInstallable: false, isPassive: false, attr: { maxhull:0, maxshield:0, maxenergy:0, armor:0, cloak:0, jump:0, slots:0}, playerBuff:{hull:0, shield:0, energy: 0}, targetBuff:{ hull: 0, shield:  0, energy: 0}, credits: 5, name: 'unnamed'})
    }

    self.remove = function () {
      self.world.items = self.world.items.filter(e => e != self.selected)
    }
    
    self.editItem = function (e) {
      self.selected = e.item.item
    }
    
    self.endEditing = function (e) {
      self.selected.name = self.refs.nameField.value
      self.selected.credits = self.refs.creditsField.value
      self.selected.isInstallable = self.refs.isInstallableToggle.checked
      self.selected.isPassive = self.refs.isPassiveToggle.checked
      self.selected.attr.maxhull = self.refs.maxhullField.value
      self.selected.attr.maxshield = self.refs.maxshieldField.value
      self.selected.attr.maxenergy = self.refs.maxenergyField.value
      self.selected.playerBuff.hull = self.refs.playerHullField.value
      self.selected.playerBuff.shield = self.refs.playerShieldField.value
      self.selected.playerBuff.energy = self.refs.playerEnergyField.value
      self.selected.targetBuff.hull = self.refs.targetHullField.value
      self.selected.targetBuff.shield = self.refs.targetShieldField.value
      self.selected.targetBuff.energy = self.refs.targetEnergyField.value
      self.selected = null
      self.update()
    }

    self.cancelEditing = function () {
      self.selected = null
      self.update()
    }

    function loadWorld() {
        self.world = getWorld()
        self.update()
    }

    self.on('mount', function() {
      window.events.on('world-updated', loadWorld)
      window.events.on('save-world', () => saveWorld(self.world))
      loadWorld()
    })

  </script>

</items-viewer>

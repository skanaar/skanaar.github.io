<items-viewer>

  <div class="toolbox">
    <button onclick={add}>+ New Item</button>
    <button onclick={sort}>Sort</button>
    <div class="btn-group">
      <a onclick={setFilter('weapon')} class="toggle-btn {(filter == 'weapon') && 'active'}">Weapons
      </a><a onclick={setFilter('module')} class="toggle-btn {(filter == 'module') && 'active'}">Modules
      </a><a onclick={setFilter('tool')} class="toggle-btn {(filter == 'tool') && 'active'}">Tools
      </a><a onclick={setFilter('quest')} class="toggle-btn {(filter == 'quest') && 'active'}">Quest
      </a><a onclick={setFilter('rare')} class="toggle-btn {(filter == 'rare') && 'active'}">Rare
      </a><a onclick={setFilter('common')} class="toggle-btn {(filter == 'common') && 'active'}">Common
      </a>
    </div>
  </div>

  <div class="table-parent">
    <table class="table attr-table">
      <thead>
        <tr>
          <th>name</th>
          <th>type</th>
          <th>credits</th>
          <th>maxhull</th>
          <th>maxshield</th>
          <th>maxenergy</th>
          <th>player-hull</th>
          <th>player-shield</th>
          <th>player-energy</th>
          <th>target-hull</th>
          <th>target-shield</th>
          <th>target-energy</th>
        </tr>
      </thead>
      <tbody>
        <tr each={item in filteredItems()} onclick={editItem} class={active: selected == item}>
          <td>{item.name}</td>
          <td>{item.type}</td>
          <td class={table_zero: !item.credits}>{item.credits}</td>
          <td class={table_zero: !item.attr.maxhull}>{item.attr.maxhull}</td>
          <td class={table_zero: !item.attr.maxshield}>{item.attr.maxshield}</td>
          <td class={table_zero: !item.attr.maxenergy}>{item.attr.maxenergy}</td>
          <td class={table_zero: !item.playerBuff.hull}>{item.playerBuff.hull}</td>
          <td class={table_zero: !item.playerBuff.shield}>{item.playerBuff.shield}</td>
          <td class={table_zero: !item.playerBuff.energy}>{item.playerBuff.energy}</td>
          <td class={table_zero: !item.targetBuff.hull}>{item.targetBuff.hull}</td>
          <td class={table_zero: !item.targetBuff.shield}>{item.targetBuff.shield}</td>
          <td class={table_zero: !item.targetBuff.energy}>{item.targetBuff.energy}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="sidebar" show={!!selected}>
    <input type=text ref="nameField" value={selected && selected.name}>
    <div class="input-grid">
      <em>type</em>
      <select ref="typeInput" value={selected && selected.type}>
        <option>weapon</option>
        <option>tool</option>
        <option>module</option>
        <option>quest</option>
        <option>rare</option>
        <option>common</option>
      </select><br/>
      <em>credits</em>     <input type=number ref="creditsField" value={selected && selected.credits}>
    </div>
    
    <label>Attributes</label>
    <div class="input-grid">
      <em>maxhull</em>   <input type=number ref="maxhullField" value={selected && selected.attr.maxhull}><br/>
      <em>maxshield</em> <input type=number ref="maxshieldField" value={selected && selected.attr.maxshield}><br/>
      <em>maxenergy</em> <input type=number ref="maxenergyField" value={selected && selected.attr.maxenergy}><br/>
    </div>
    
    <label>User effect on use</label>
    <div class="input-grid">
      <em>hull</em>   <input type=number ref="playerHullField" value={selected && selected.playerBuff.hull}><br/>
      <em>shield</em> <input type=number ref="playerShieldField" value={selected && selected.playerBuff.shield}><br/>
      <em>energy</em> <input type=number ref="playerEnergyField" value={selected && selected.playerBuff.energy}>
    </div>
    
    <label>Target effect on use</label>
    <div class="input-grid">
      <em>hull</em>   <input type=number ref="targetHullField" value={selected && selected.targetBuff.hull}><br/>
      <em>shield</em> <input type=number ref="targetShieldField" value={selected && selected.targetBuff.shield}><br/>
      <em>energy</em> <input type=number ref="targetEnergyField" value={selected && selected.targetBuff.energy}>
    </div>

    <br/>
    <button onclick={remove}>Delete</button>
    <button onclick={endEditing}>Done</button>
    <button onclick={cancelEditing}>Cancel</button>
  </div>

  <script>
    var self = this
    var app = self.opts.app ||Â window.app

    self.world = { items: [] }
    self.selected = null
    self.filter = null
    
    self.setFilter = function (type) {
      return () => self.filter = (self.filter == type ? null : type)
    }

    self.sort = function () {
      var order = ['weapon', 'tool', 'module', 'common', 'quest']
      self.world.items.sort(function (a,b) {
        var typeDelta = order.indexOf(a.type) - order.indexOf(b.type)
        return (typeDelta == 0) ? a.credits - b.credits : typeDelta
      })
    }

    self.add = function () {
      self.world.items.unshift({
        type: self.filter || 'common',
        credits: 5,
        name: 'unnamed',
        attr: { maxhull:0, maxshield:0, maxenergy:0, armor:0, cloak:0, jump:0, slots:0},
        playerBuff:{hull:0, shield:0, energy: 0},
        targetBuff:{ hull: 0, shield:  0, energy: 0}
      })
    }

    self.remove = function () {
      self.world.items = self.world.items.filter(e => e != self.selected)
    }

    self.filteredItems = function () {
      return self.filter ? self.world.items.filter(e => e.type == self.filter) : self.world.items
    }
    
    self.editItem = function (e) {
      self.selected = e.item.item
    }
    
    self.endEditing = function (e) {
      self.selected.name = self.refs.nameField.value
      self.selected.type = self.refs.typeInput.value
      self.selected.credits = +self.refs.creditsField.value
      self.selected.attr.maxhull = +self.refs.maxhullField.value
      self.selected.attr.maxshield = +self.refs.maxshieldField.value
      self.selected.attr.maxenergy = +self.refs.maxenergyField.value
      self.selected.playerBuff.hull = +self.refs.playerHullField.value
      self.selected.playerBuff.shield = +self.refs.playerShieldField.value
      self.selected.playerBuff.energy = +self.refs.playerEnergyField.value
      self.selected.targetBuff.hull = +self.refs.targetHullField.value
      self.selected.targetBuff.shield = +self.refs.targetShieldField.value
      self.selected.targetBuff.energy = +self.refs.targetEnergyField.value
      self.selected = null
      self.update()
    }

    self.cancelEditing = function () {
      self.selected = null
      self.update()
    }

    self.on('before-mount', function() {
      self.world = app.getWorld()
      app.events.on('world-updated', self.update)
    })

    self.on('unmount', function() {
      app.events.off('world-updated', self.update)
    })

  </script>

</items-viewer>

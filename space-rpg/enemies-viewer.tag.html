<enemies-viewer>

  <div class="table-parent">
    <table class="table attr-4-table">
      <thead>
        <tr>
          <th>Enemy ships</th>
          <th>level</th>
          <th>equipment</th>
          <th>slots</th>
          <th>maxhull</th>
          <th>maxshield</th>
          <th>maxenergy</th>
          <th>generate hull</th>
          <th>generate shield</th>
          <th>generate energy</th>
        </tr>
      </thead>
      <tbody>
        <tr each={ship in world.enemies} onclick={edit} class={active: selected == ship}>
          <td>{ship.name}</td>
          <td>{ship.level}</td>
          <td>{ship.inventory.join()}</td>
          <td>{ship.slots}</td>
          <td class={table_zero: !ship.attr.maxhull}>{ship.attr.maxhull}</td>
          <td class={table_zero: !ship.attr.maxshield}>{ship.attr.maxshield}</td>
          <td class={table_zero: !ship.attr.maxenergy}>{ship.attr.maxenergy}</td>
          <td class={table_zero: !ship.generator.hull}>{ship.generator.hull}</td>
          <td class={table_zero: !ship.generator.shield}>{ship.generator.shield}</td>
          <td class={table_zero: !ship.generator.energy}>{ship.generator.energy}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="toolbox">
    <button onclick={add}>+ New Enemy</button>
    <div class="btn-group">
      <a class="toggle-btn" onclick={up}>Up in list
      </a><a class="toggle-btn" onclick={down}>Down in list</a>
    </div>
  </div>

  <div class="sidebar" show={!!selected}>
    <input type=text ref="nameField" value={selected && selected.name}>
    <div class="input-grid">
      <em>visual</em>
      <select ref="visualInput">
        <option each={e in models()}>{e.name}</option>
      </select><br />
      <em>level</em> <input type=number ref=levelField value={selected && selected.level || 0}>
    </div>
    
    <label>Attributes</label>
    <div class="input-grid">
      <em>maxhull</em>   <input type=number step=1 ref="maxhullField" value={selected && selected.attr.maxhull}><br/>
      <em>maxshield</em> <input type=number step=1 ref="maxshieldField" value={selected && selected.attr.maxshield}><br/>
      <em>maxenergy</em> <input type=number step=1 ref="maxenergyField" value={selected && selected.attr.maxenergy}><br/>
      <em>slots</em>     <input type=number step=1 ref="slotsField" value={selected && selected.slots}><br/>
    </div>
    
    <label>Generators</label>
    <div class="input-grid">
      <em>hull</em>   <input type=number step=1 ref="hullField" value={selected && selected.generator.hull}><br/>
      <em>shield</em> <input type=number step=1 ref="shieldField" value={selected && selected.generator.shield}><br/>
      <em>energy</em> <input type=number step=1 ref="energyField" value={selected && selected.generator.energy}>
    </div>

    <label>Equipment</label>
    <div class="input-grid">
      <em>level range</em> <input readonly value={equipmentLevel}>
    </div>
    <button onclick={chooseEquipment}>Choose equipment</button>

    <ship-card app={app} ship={selected} />

    <label></label>
    <button onclick={remove}>Delete</button>
    <button onclick={endEditing}>Done</button>
    <button onclick={cancelEditing}>Cancel</button>
  </div>

  <script>
    var self = this
    var app = self.opts.app || window.app

    self.app = app
    self.world = { ships: [], enemies: [] }
    self.selected = null

    self.models = () => self.world.models.filter(e => !e.tags || !e.tags.includes('anomaly'))

    self.remove = function () {
      self.world.ships = self.world.ships.filter(e => e != self.selected)
      self.world.enemies = self.world.enemies.filter(e => e != self.selected)
    }

    self.add = function () {
      self.world.enemies.push({
        attr: { maxhull:0, maxshield:0, maxenergy:0, armor:0, cloak:0, jump:0, slots:0},
        generator:{hull:0, shield:0, energy: 0},
        name: 'unnamed',
        level: 1,
        slots: 0,
        visual: 'monitor-drone',
        inventory: [],
        isFlying: true
      })
    }
    
    var printableRange = es => _.min(es.map(e => e.level)) + ' - ' + _.max(es.map(e => e.level))

    self.edit = function (e) {
      self.selected = e.item.ship
      self.refs.visualInput.value = self.selected.visual
      if (self.selected.inventory) {
        var items = self.selected.inventory.map(id => app.world.items.find(item => item.name==id) || { level: 0 })
        self.equipmentLevel = printableRange(items)
      }
    }
    
    self.endEditing = function () {
      if (!self.selected) return
      self.selected.name = self.refs.nameField.value
      self.selected.level = +self.refs.levelField.value
      self.selected.slots = +self.refs.slotsField.value
      self.selected.visual = self.refs.visualInput.value
      self.selected.attr.maxhull = +self.refs.maxhullField.value
      self.selected.attr.maxshield = +self.refs.maxshieldField.value
      self.selected.attr.maxenergy = +self.refs.maxenergyField.value
      self.selected.generator.hull = +self.refs.hullField.value
      self.selected.generator.shield = +self.refs.shieldField.value
      self.selected.generator.energy = +self.refs.energyField.value
      self.selected = null
      self.update()
    }

    self.cancelEditing = function () {
      self.selected = null
      self.update()
    }

    self.chooseEquipment = function () {
      app.events.trigger('show-item-chooser', self.selected.inventory)
    }

    self.up = function () {
      _.bubbleUp(self.world.enemies, self.world.enemies.findIndex(e => e == self.selected))
    }

    self.down = function () {
      _.bubbleDown(self.world.enemies, self.world.enemies.findIndex(e => e == self.selected))
    }

    self.on('before-mount', function() {
      self.world = app.getWorld()
      app.events.on('world-updated', self.update)
      app.events.on('save-entity', self.endEditing)
    })

    self.on('unmount', function() {
      app.events.off('world-updated', self.update)
      app.events.off('save-entity', self.endEditing)
    })

  </script>

</enemies-viewer>

<!DOCTYPE html>
<html>
<head>
  <title>space rpg</title>
  <link rel="shortcut icon" href="favicon.png">
  <link rel="stylesheet" href="editor.css">
  <link rel="stylesheet" href="card.css">
  <link rel="stylesheet" href="modal.css">
  <link rel="stylesheet" href="map.css">
  <link rel="stylesheet" href="lib/codemirror.css">
  <link rel="stylesheet" href="lib/mdn-like.css">
  <style>
    .CodeMirror {
      position: fixed;
      left: 251px;
      top: 26px;
      right: 151px;
      font-size: 16px;
      font-family: Menlo, Consolas, monospace;
      padding: 45px 10px 30px 10px;
    }
  </style>
</head>
<body class="enable-scroll">
    <editor-app></editor-app>

    <!-- riot tags -->
    <script type="riot/tag" src="editor-app.tag.html"></script>
    <script type="riot/tag" src="file-menu.tag.html"></script>
    <script type="riot/tag" src="map-viewer.tag.html"></script>
    <script type="riot/tag" src="overview-viewer.tag.html"></script>
    <script type="riot/tag" src="region-summary.tag.html"></script>
    <script type="riot/tag" src="ship-card.tag.html"></script>
    <script type="riot/tag" src="item-card.tag.html"></script>
    <script type="riot/tag" src="models-viewer.tag.html"></script>
    <script type="riot/tag" src="items-viewer.tag.html"></script>
    <script type="riot/tag" src="item-chooser.tag.html"></script>
    <script type="riot/tag" src="ship-chooser.tag.html"></script>
    <script type="riot/tag" src="ships-viewer.tag.html"></script>
    <script type="riot/tag" src="enemies-viewer.tag.html"></script>
    <script type="riot/tag" src="terrain-preview.tag.html"></script>
    <script type="riot/tag" src="filter-tools.tag.html"></script>
    <script type="riot/tag" src="celestial-preview.tag.html"></script>
    <script type="riot/tag" src="celestials-viewer.tag.html"></script>
    <script type="riot/tag" src="quest-list.tag.html"></script>
    <script type="riot/tag" src="validation-report.tag.html"></script>

    <script src="lib/codemirror.js"></script>
    <script src="lib/xml.js"></script>
    <script src="lib/riot.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/aws.js"></script>
    <script src="util.js"></script>
    <script src="validator.js"></script>
    <script>

      function parseWorld(worldJson) {
        var world = JSON.parse(worldJson)
        if (!_.isArray(world.destinations)) throw new Error()
        if (!_.isArray(world.celestials)) throw new Error()
        if (!_.isArray(world.regions)) throw new Error()
        if (!_.isArray(world.quests)) throw new Error()
        if (!_.isArray(world.items)) throw new Error()
        if (!_.isArray(world.ships)) throw new Error()
        if (!_.isArray(world.enemies)) throw new Error()
        window.world = world
        return world
      }

      function startEditor(world){
        riot.mount('editor-app', { world: world })
      }
      function loadFromServer() {
        _.fetch('world.json', data => startEditor(parseWorld(data)))
      }

      function initialize() {
        var useLocalStorage = !! _.jsonParse(localStorage['nebula:use-local-storage'] || 'false')
        var worldJson = localStorage['nebula:world']
        if (!useLocalStorage || !worldJson) {
          loadFromServer()
        }
        else {
          try {
            startEditor(parseWorld(worldJson))            
          } catch(e) {
            alert('locally stored world was corrupt, loading world from server')
            loadFromServer()
          }
        }
      }

      initialize()

    </script>
</body>
</html>
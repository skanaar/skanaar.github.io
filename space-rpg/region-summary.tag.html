<region-summary>

  <label>Summary</label>
  <div class="input-grid">
    <em>treasures</em> <input type=text readonly value={treasureSum()}><br />
    <em>treasures</em> <input type=text readonly value={treasureLevel()}><br />
    <em>enemies</em> <input type=text readonly value={enemyLevel()}><br />
    <em>loot</em> <input type=text readonly value={lootLevel()}>
  </div>

  <script>
    var self = this
    var app = this.opts.app || window.app

    function guard(func) {
      var region = null
      var cache = 0
      return function () {
        if (!this.opts.region || !this.opts.region.pos) {
          region = null
          return 0
        }
        if (region == this.opts.region) return cache
        region = this.opts.region
        cache = func(region)
        return cache
      }
    }

    self.treasureSum = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius)
      var itemIds = _.flatten(members.map(e => [e.treasures, (e.enemy ? e.enemy.loot : 0)]))
      var items = itemIds.map(id => app.world.items.find(item => item.name==id) || { credits: 0 })
      return _.sum(items, 'credits') + ' credits'
    })

    var installable = item => item.type != 'rare' && item.type != 'common' && item.type != 'quest'
    var getItems = ids => ids.map(id => app.world.items.filter(installable).find(item => item.name==id) || { level: 0 })
    var printableRange = es => _.min(es.map(e => e.level)) + ' - ' + _.max(es.map(e => e.level))

    self.enemyLevel = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius && e.enemy)
      var enemyIds = members.map(e => e.enemy.type)
      var enemies = _.compact(enemyIds.map(id => app.world.enemies.find(enemy => enemy.name == id)))
      return printableRange(enemies)
    })

    self.treasureLevel = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius)
      var items = getItems(_.flatten(members.map(e => e.treasures)))
      return printableRange(items)
    })

    self.lootLevel = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius && e.enemy)
      var items = getItems(_.flatten(members.map(e => e.enemy.loot)))
      return printableRange(items)
    })
  </script>

</region-summary>

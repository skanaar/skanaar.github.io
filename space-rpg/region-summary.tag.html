<region-summary>

  <div class="summary" if={opts.compact}>
    <div><b title="Level range of enemies">ðŸ‘¾ {enemyLevel()}</b></div>
    <div><span title="Total collectable credits">ðŸ’µ </span> {creditsSum()}</div>
    <div if={treasureLevel() != 'none'}><span title="Level range of treasures">ðŸ“¦</span> {treasureLevel()}</div>
  </div>

  <div class="summary" if={!opts.compact}>
    <div>Collectable: {creditsSum()}</div>
    <div>Enemy Lvl: {enemyLevelRange()}</div>
    <div>Loot Lvl: {lootLevel()}</div>
    <div>Treasure Lvl: {treasureLevel()}</div>
  </div>

  <style>
    .summary {
      line-height: 14px;
    }
  </style>

  <script>
    var self = this
    var app = this.opts.app || window.app

    function guard(func) {
      var region = null
      var cache = 0
      return function () {
        if (!this.opts.region || !this.opts.region.pos) {
          region = null
          return 0
        }
        if (region == this.opts.region) return cache
        region = this.opts.region
        cache = func(region)
        return cache
      }
    }

    self.creditsSum = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius)
      var itemIds = _.flatten(members.map(e => [e.treasures, (e.enemy ? e.enemy.loot : 0)]))
      var items = itemIds.map(id => app.world.items.find(item => item.name==id) || { credits: 0 })
      return _.sum(items, 'credits') + ' c'
    })

    var spawnedEnemies = _.object(
      _.flatten(app.world.quests.map(e => e.xml.split('\n')))
      .filter(e => e.includes('<place-enemy'))
      .map(e => [e.match(/dest="([^"]*)"/)[1], e.match(/enemy="([^"]*)"/)[1]])
    )

    function installable(item) {
      return item.type != 'rare' && item.type != 'common' && item.type != 'quest'
    }
    function getItems(ids) {
      return ids.map(id => app.world.items.find(item => item.name==id) || { level: 0 }).filter(installable)
    }
    var printableRange = function (es) {
      return es.length ? (_.min(es.map(e => e.level)) + ' - ' + _.max(es.map(e => e.level))) : 'none'
    }

    self.enemyLevelRange = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius && e.enemy)
      var enemyIds = members.map(e => e.enemy.type)
      var enemies = _.compact(enemyIds.map(id => app.world.enemies.find(enemy => enemy.name == id)))
      return printableRange(enemies)
    })

    self.enemyLevel = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius)
      var enemyIds = _.flatten(members.map(e => [e.enemy && e.enemy.type, spawnedEnemies[e.name]]))
      var enemies = _.compact(enemyIds.map(id => app.world.enemies.find(enemy => enemy.name == id)))
      return enemies.length ? _.max(enemies.map(e => e.level)) :Â 0
    })

    self.treasureLevel = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius)
      var items = getItems(_.flatten(members.map(e => e.treasures)))
      return printableRange(items)
    })

    self.lootLevel = guard(function (region) {
      var members = app.world.destinations.filter(e => dist(e.pos, region.pos) < region.radius && e.enemy)
      var items = getItems(_.flatten(members.map(e => e.enemy.loot)))
      return printableRange(items)
    })
  </script>

</region-summary>

<battle-simulator>

  <div class="battle-simulator">
    <div class="input-grid">
      <em>player</em>
      <select ref="shipSelect" onchange={onPlayerChanged}>
        <option each={e in world.ships}>{e.name}</option>
      </select>
    </div>
    <div class="input-grid">
      <em>hull</em>   <b>{protagonist && protagonist.levels.hull}</b><br/>
      <em>shield</em> <b>{protagonist && protagonist.levels.shield}</b><br/>
      <em>energy</em> <b>{protagonist && protagonist.levels.energy}</b><br/>
      <em>maxhull</em>   <b>{protagonist && protagonist.attr.maxhull}</b><br/>
      <em>maxshield</em> <b>{protagonist && protagonist.attr.maxshield}</b><br/>
      <em>maxenergy</em> <b>{protagonist && protagonist.attr.maxenergy}</b><br/>
      <em>jump</em>      <b>{protagonist && protagonist.attr.jump}</b><br/>
      <em>slots</em>     <b>{protagonist && protagonist.attr.slots}</b><br/>
      <em>hull recharge</em>   <b>{protagonist && protagonist.generator.hull}</b><br/>
      <em>shield recharge</em> <b>{protagonist && protagonist.generator.shield}</b><br/>
      <em>energy recharge</em> <b>{protagonist && protagonist.generator.energy}</b><br/>
      <button onclick={chooseEquipment}>Choose equipment</button><br/>
      <select ref="itemSelect">
        <option each={e in (protagonist || {}).inventory}>{e}</option>
      </select>
      <button onclick={useItem}>Use item</button>
    </div>

    <div class="input-grid">
      <em>enemy</em>
      <select ref="enemySelect" onchange={onEnemyChanged}>
        <option each={e in world.enemies}>{e.name}</option>
      </select>
    </div>
    <div class="input-grid">
      <em>hull</em>      <b>{antagonist && antagonist.levels.hull}</b><br/>
      <em>shield</em>    <b>{antagonist && antagonist.levels.shield}</b><br/>
      <em>energy</em>    <b>{antagonist && antagonist.levels.energy}</b><br/>
      <em>maxhull</em>   <b>{antagonist && antagonist.attr.maxhull}</b><br/>
      <em>maxshield</em> <b>{antagonist && antagonist.attr.maxshield}</b><br/>
      <em>maxenergy</em> <b>{antagonist && antagonist.attr.maxenergy}</b><br/>
      <em>jump</em>      <b>{antagonist && antagonist.attr.jump}</b><br/>
      <em>slots</em>     <b>{antagonist && antagonist.attr.slots}</b><br/>
      <em>hull</em>      <b>{antagonist && antagonist.generator.hull}</b><br/>
      <em>shield</em>    <b>{antagonist && antagonist.generator.shield}</b><br/>
      <em>energy</em>    <b>{antagonist && antagonist.generator.energy}</b>
    </div>
  </div>

  <item-chooser />

  <style>
    .battle-simulator {
      margin: 50px auto;
      width: 300px;
    }
  </style>

  <script>
    var self = this

    self.world = { ships: [], enemies: [] }
    self.protagonist = null
    self.antagonist = null

    self.chooseEquipment = function () {
      window.events.trigger('show-item-chooser', self.protagonist.inventory)
    }

    self.onPlayerChanged = function () {
      var ship = _.findWhere(self.world.ships, { name: self.refs.shipSelect.value })
      self.protagonist = realize(ship)
    }

    self.onEnemyChanged = function () {
      var ship = _.findWhere(self.world.ships, { name: self.refs.shipSelect.value })
      self.antagonist = realize(ship)
    }

    function realize(template) {
      var ship = JSON.parse(JSON.stringify(template))
      calcAttributes(ship)
      return ship
    }

    function calcAttributes(ship) {
      ship.inventory = ship.inventory || []
      ship.items = ship.inventory.map(id => _.findWhere(self.world.items, { name: id }))
      ship.attributes = {
        maxhull:   ship.attr.maxhull   + _.sum(ship.items, e => e.attr.maxhull),
        maxshield: ship.attr.maxshield + _.sum(ship.items, e => e.attr.maxshield),
        maxenergy: ship.attr.maxenergy + _.sum(ship.items, e => e.attr.maxenergy),
        jump:      ship.attr.jump      + _.sum(ship.items, e => e.attr.jump),
        slots:     ship.attr.slots     + _.sum(ship.items, e => e.attr.slots)
      }
      ship.levels = {
        hull: ship.attributes.maxhull,
        shield: ship.attributes.maxshield,
        energy: ship.attributes.maxenergy
      }
    }

    function loadWorld() {
      self.world = getWorld()
      self.protagonist = realize(self.world.ships[0])
      self.antagonist = realize(self.world.enemies[0])
      self.update()
    }

    self.on('mount', function() {
      window.events.on('world-updated', loadWorld)
      window.events.on('item-chooser-closed', function () {
        calcAttributes(self.protagonist)
        calcAttributes(self.antagonist)
      })
      loadWorld()
    })

  </script>

</battle-simulator>

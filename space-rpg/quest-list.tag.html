<quest-list>

  <div class="list">
    <div each={quest in world.quests} onclick={edit} class={ list_item: true, active: quest.name==active }>
      {quest.name}
    </div>
    <div><button onclick={add}>+ New Quest</button></div>
  </div>

  <div class="quest-tools">
    <input type="text" value={active} ref="nameField">
    <button onclick={save}>Save</button>
    <button onclick={remove}>Delete</button>
    <button onclick={up}>Up</button>
    <button onclick={down}>Down</button>
  </div>

  <div class="sidebar">
    <label>Templates</label>
    <div each={e in templates}>
      <button class="quest-template" onclick={useTemplate}>{e.name}</button>
    </div>
  </div>

  <script>
    var self = this

    self.world = window.nullWorld()
    self.active = null
    self.templates = [
      { name: 'Condition', template: '<condition have-item="" at-dest="" no-enemy-at-dest="" not-at-dest="" have-credits="" trigger="TRIGGER"/>' },
      { name: 'Place item', template: '<place-item dest="" item=""/>' },
      { name: 'Place trader inventory', template: '<place-inventory dest="" item=""/>' },
      { name: 'Dialog', template: '<dialog>"Hey hitchhiker!"</dialog>' },
      { name: 'Dialog with choice', template: '<dialog ok="YES PLEASE" cancel="NO THANKS">"Would you like some tea?"</dialog>' },
      { name: 'Add to quest list', template: '<add-to-quest-list/>' },
      { name: 'Give credits', template: '<give credits=""/>' },
      { name: 'Give item', template: '<give item=""/>' },
      { name: 'Take credits', template: '<take credits=""/>' },
      { name: 'Take item', template: '<take item=""/>' },
      { name: 'Mark on map', template: '<mark-on-map dest="" color="0x0F0" icon="arrow"/>' },
      { name: 'Remove map marker', template: '<remove-map-marker/>' },
      { name: 'Change ship', template: '<change-ship ship=""/>' },
      { name: 'Travel', template: '<travel dest=""/>' },
      { name: 'Script goto', template: '<goto jump="1"/>' }
    ]

    function loadQuests(world) {
      self.world = world
      self.update()
    }

    self.useTemplate = function (e) {
      var src = window.codeMirrorInstance.getValue()
      src = src + '\n' + e.item.e.template
      window.codeMirrorInstance.setValue(src)
    }

    self.add = function () {
      self.world.quests.push({ name: 'unnamed', xml: '' })
    }

    self.edit = function (e) {
      self.save()
      self.active = e.item.quest.name
      window.codeMirrorInstance.setValue(e.item.quest.xml)
    }

    self.save = function () {
      var quest = _.findWhere(self.world.quests, { name: self.active })
      if (quest) {
        quest.name = self.refs.nameField.value
        quest.xml = window.codeMirrorInstance.getValue()
      }
    }

    self.remove = function () {
      self.world.quests = _.filter(self.world.quests, q => q.name != self.active)
    }

    self.up = function () {
      _.bubbleUp(self.world.quests, self.world.quests.findIndex(e => e.name == self.active))
    }

    self.down = function () {
      _.bubbleDown(self.world.quests, self.world.quests.findIndex(e => e.name == self.active))
    }

    self.on('mount', function() {
      window.events.on('world-updated', () => loadQuests(getWorld()))
      window.events.on('save-world', () => saveWorld(self.world))
      loadQuests(getWorld())
    })
  </script>

  <style>
    .quest-tools {
      position: fixed;
      top: 31px;
      left: 255px;
      z-index: 2;
    }
    .quest-template {
      margin-bottom: 5px;
      padding: 3px 8px;
      width: 95%;
    }
  </style>

</quest-list>

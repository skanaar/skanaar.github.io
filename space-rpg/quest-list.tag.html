<quest-list>

  <div class="list">
    <div class="tools">
      <div class="btn-group">
        <a each={e in allTags()} onclick={setFilter(e)} class="toggle-btn {(filter == e) && 'active'}">{e}
        </a>
      </div>
    </div>
    <div each={quest in filteredQuests()} onclick={edit} class={ list_item: true, active: quest.name==active }>
      {quest.name}
    </div>
  </div>

  <textarea id="quest-editor"></textarea>

  <div class="toolbox quest-tools">
    <button onclick={add}>+ New Quest</button>
    <div class="btn-group">
      <a class="toggle-btn" onclick={up}>Up in list</a><a class="toggle-btn" onclick={down}>Down in list</a>
    </div>
    <select onchange={setInitialState} value={world.initialState} ref="stateSelect">
      <option value="surface">Start on surface</option>
      <option value="space">Start in space</option>
    </select>
  </div>

  <div class="sidebar">
    <label>Name</label>
    <input type="text" value={selected && selected.name} onchange={setFields} ref="nameField">
    <label>Tags</label>
    <input type="text" value={selected && selected.tags} onchange={setFields} ref="tagsField" placeholder="Tags...">
    <label></label>
    <button onclick={save}>Save</button>
    <button onclick={remove}>Delete</button>
    <label>Append template</label>
    <div each={e in templates}>
      <button class="quest-template" onclick={useTemplate}>{e.name}</button>
    </div>
  </div>

  <script>
    var self = this
    var app = this.opts.app || window.app
    self.world = app.nullWorld()
    self.selected = null
    self.templates = [
      { name: 'Condition', template: '<condition have-item="" at-dest="" no-enemy-at-dest="" not-at-dest="" have-credits="" trigger="TRIGGER"/>' },
      { name: 'Place item', template: '<place-item dest="" item=""/>' },
      { name: 'Place trader inventory', template: '<place-inventory dest="" item=""/>' },
      { name: 'Place enemy', template: '<place-enemy dest="" enemy=""/>' },
      { name: 'Dialog', template: '<dialog>"Hey hitchhiker!"</dialog>' },
      { name: 'Dialog with choice', template: '<dialog ok="YES PLEASE" cancel="NO THANKS">"Would you like some tea?"</dialog>' },
      { name: 'Add to quest list', template: '<add-to-quest-list/>' },
      { name: 'Give credits', template: '<give credits=""/>' },
      { name: 'Give item', template: '<give item=""/>' },
      { name: 'Take credits', template: '<take credits=""/>' },
      { name: 'Take item', template: '<take item=""/>' },
      { name: 'Mark on map', template: '<mark-on-map dest="" color="0x0F0" icon="arrow"/>' },
      { name: 'Remove map marker', template: '<remove-map-marker/>' },
      { name: 'Change ship', template: '<change-ship ship=""/>' },
      { name: 'Travel', template: '<travel dest=""/>' },
      { name: 'Script goto', template: '<goto jump="1"/>' }
    ]
    self.filter = ''
    self.allTags = () => app.allTags(self.world.quests).filter(e => e)
    self.filteredQuests = () => app.tagFilter(self.world.quests, self.filter)
    self.setInitialState = function () {
      self.world.initialState = self.refs.stateSelect.value
    }

    self.setFilter = function (type) {
      return () => self.filter = (self.filter == type ? null : type)
    }

    self.useTemplate = function (e) {
      var src = self.cmEditor.getValue()
      src = src + '\n' + e.item.e.template
      self.cmEditor.setValue(src)
    }

    self.add = function () {
      self.filter = ''
      self.world.quests.unshift({ name: 'unnamed', xml: '' })
    }

    self.edit = function (e) {
      self.save()
      self.selected = e.item.quest
      self.cmEditor.setValue(e.item.quest.xml)
    }

    self.setFields = function () {
      if (self.selected) {
        self.selected.name = self.refs.nameField.value
        self.selected.tags = self.refs.tagsField.value
      }
    }

    self.save = function () {
      if (self.selected) {
        self.selected.xml = self.cmEditor.getValue()
      }
    }

    self.remove = function () {
      self.world.quests = _.filter(self.world.quests, q => q != self.selected)
    }

    self.up = function () {
      _.bubbleUp(self.world.quests, self.world.quests.findIndex(e => e == self.selected))
    }

    self.down = function () {
      _.bubbleDown(self.world.quests, self.world.quests.findIndex(e => e == self.selected))
    }

    function createEditor() {
      var textarea = document.getElementById('quest-editor')
      self.cmEditor = CodeMirror.fromTextArea(textarea, { 
        mode: 'xml',
        theme: 'mdn-like',
        lineWrapping: true
      })
      function setEditorSize() {
        self.cmEditor.setSize(window.innerWidth-251-200, window.innerHeight-26-26-19)
      }
      setEditorSize()
      self.resizeCallback = _.throttle(setEditorSize, 100)
      window.addEventListener('resize', self.resizeCallback)
    }

    function destroyEditor() {
      self.cmEditor.toTextArea()
      window.removeEventListener('resize', self.resizeCallback)
    }

    self.on('mount', function() {
      self.world = app.getWorld()
      createEditor()
      app.events.on('world-updated', self.update)
      self.update()
    })

    self.on('before-unmount', function() {
      app.events.off('world-updated', self.update)
    })
  </script>

  <style>
    .quest-tools {
      z-index: 2;
    }
    .quest-template {
      margin-bottom: 2px;
      width: 95%;
    }
  </style>

</quest-list>

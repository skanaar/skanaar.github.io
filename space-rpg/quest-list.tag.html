<quest-list>

  <main-menu></main-menu>

  <div class="quest-list">
    <div each={quest in quests} onclick={edit} class={ active: quest.title==active }>{quest.title}</div>
    <div><button onclick={add}>+ New Quest</button></div>
  </div>

  <div class="quest-tools">
    <input type=text value={active} ref="nameField">
    <button onclick={save}>Save</button>
  </div>

  <script>
    var self = this

    self.quests = []
    self.active = null

    function loadQuests(data) {
      var dom = (new DOMParser()).parseFromString(data, 'text/xml')
      self.quests = _.map(dom.getElementsByTagName('quest'), function (e) {
        return {
          title: e.getAttribute('title'),
          source: e.innerHTML.split('  ').join('').trim()
        }
      })
      self.update()
    }

    self.add = function () {
      self.quests.push({ title: 'unnamed', source: '<condition />' })
    }

    self.edit = function (e) {
      self.active = e.item.quest.title
      window.codeMirrorInstance.setValue(e.item.quest.source)
    }

    self.save = function () {
      var quest = _.findWhere(self.quests, { title: self.active })
      quest.title = self.refs.nameField.value
      quest.source = window.codeMirrorInstance.getValue()
      self.active = null
    }

    self.on('mount', function() {
      _.fetch('quests.xml', function (data) { loadQuests(data) })
    })
  </script>

  <style>
    .quest-list {
      position: fixed;
      top: 26px;
      left: 0;
      bottom: 0;
      overflow: auto;
      width: 250px;
    }
    .quest-list div {
      padding: 10px;
    }
    .quest-list div.active {
      background: #eee;
    }
    .quest-tools {
      position: fixed;
      top: 31px;
      left: 255px;
      z-index: 2;
    }
  </style>

</quest-list>

<quest-list>

  <div class="list">
    <div each={quest in quests} onclick={edit} class={ list_item: true, active: quest.title==active }>
      {quest.title}
    </div>
    <div><button onclick={add}>+ New Quest</button></div>
  </div>

  <div class="quest-tools">
    <input type="text" value={active} ref="nameField">
    <button onclick={save}>Save</button>
    <button onclick={remove}>Delete</button>
  </div>

  <div class="sidebar">
    <div each={e in templates}>
      <button onclick={useTemplate}>{e.name}</button>
    </div>
  </div>

  <script>
    var self = this

    self.quests = []
    self.active = null
    self.templates = [
      { name: 'Condition', template: '<condition have-item="" at-dest="" no-enemy-at-dest="" not-at-dest="" have-credits="" trigger="auto"/>' },
      { name: 'Place item', template: '<place-item dest="" item=""/>' },
      { name: 'Place trader inventory', template: '<place-inventory dest="" item=""/>' },
      { name: 'Dialog', template: '<dialog>"Hey hitchhiker!"</dialog>' },
      { name: 'Dialog with choice', template: '<dialog ok="YES PLEASE" cancel="NO THANKS">"Would you like some tea?"</dialog>' },
      { name: 'Add to quest list', template: '<add-to-quest-list/>' },
      { name: 'Give credits', template: '<give credits=""/>' },
      { name: 'Give item', template: '<give item=""/>' },
      { name: 'Take credits', template: '<take credits=""/>' },
      { name: 'Take item', template: '<take item=""/>' },
      { name: 'Mark on map', template: '<mark-on-map dest="" color="0x0F0" icon="arrow"/>' },
      { name: 'Remove map marker', template: '<remove-map-marker/>' },
      { name: 'Change ship', template: '<change-ship ship=""/>' },
      { name: 'Travel', template: '<travel dest=""/>' },
      { name: 'Script goto', template: '<goto jump="1"/>' }
    ]

    function loadQuests(world) {
      var dom = (new DOMParser()).parseFromString(world.quests, 'text/xml')
      self.quests = _.map(dom.getElementsByTagName('quest'), function (e) {
        return {
          title: e.getAttribute('title'),
          source: e.innerHTML.split('  ').join('').trim()
        }
      })
      self.update()
    }

    self.useTemplate = function (e) {
      var src = window.codeMirrorInstance.getValue()
      src = src + '\n' + e.item.e.template
      window.codeMirrorInstance.setValue(src)
    }

    self.add = function () {
      self.quests.push({ title: 'unnamed', source: '' })
    }

    self.edit = function (e) {
      self.active = e.item.quest.title
      window.codeMirrorInstance.setValue(e.item.quest.source)
    }

    self.save = function () {
      var quest = _.findWhere(self.quests, { title: self.active })
      quest.title = self.refs.nameField.value
      quest.source = window.codeMirrorInstance.getValue()
    }

    self.remove = function () {
      self.quests = _.filter(self.quests, q => q.title != self.active)
    }

    function questsXml() {
      var quests = self.quests.map(q => '<quest title="'+ q.title +'">'+q.source+'</quest>')
      return '<quests>' + quests.join('') + '</quests>'
    }

    self.on('mount', function() {
      window.events.on('world-updated', () => loadQuests(getWorld()))
      window.events.on('save-world', function () {
        var world = getWorld()
        world.quests = questsXml()
        saveWorld(world)
      })
      loadQuests(getWorld())
    })
  </script>

  <style>
    .quest-tools {
      position: fixed;
      top: 31px;
      left: 255px;
      z-index: 2;
    }
  </style>

</quest-list>

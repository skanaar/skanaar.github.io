<quest-list>

  <div class="list">
    <div class="tools">
      <filter-tools ref="filterInput" types={allTags()} onfilter={update} />
    </div>
    <div each={quest in filteredItems()} onclick={edit} class={ list_item: true, active: quest==selected }>
      {quest.name}
    </div>
  </div>

  <textarea id="quest-editor"></textarea>

  <div if={selected} class="toolbox quest-tools">
    <button onclick={add}>+ New Quest</button>
    <button onclick={popupFormattedText}>{!formattedText ? 'Show' : 'Hide'} formatted</button>
    <button onclick={previewDialog}>{!preview ? 'Show' : 'Hide'} preview</button>
    <div class="btn-group">
      <a class="toggle-btn" onclick={up}>Up in list</a><a class="toggle-btn" onclick={down}>Down in list</a>
    </div>
  </div>

  <div if={!!formattedText} class="quest-preview">
    <textarea rows=10 class="quest-all-formatted">{formattedText}</textarea>
  </div>

  <div if={preview} class="quest-preview">
    <div each={page in preview}>{page}</div>
  </div>

  <div class="sidebar" if={selected}>
    <label>Name</label>
    <input type="text" value={selected && selected.name} onchange={setFields} ref="nameField">
    <div class="input-grid">
      <em>color</em> 
      <input type=color onchange={setFields} ref="colorField" value={selected && toLongColor(selected.color)}><br/>
      <em>icon</em>
      <select ref="iconSelect" onchange={setFields} value={selected && selected.icon}>
        <option each={icon in icons}>{icon}</option>
      </select><br/>
      <em>is file</em><input type=checkbox onchange={setFields} ref="isFileCheckbox" checked={selected && selected.isFile}>
    </div>
    <label>Tags</label>
    <input type="text" value={selected && selected.tags} onchange={setFields} ref="tagsField" placeholder="Tags...">
    <label></label>
    <button onclick={itemChooser}>Open item chooser</button>
    <label></label>
    <button onclick={save}>Save</button>
    <button onclick={remove}>Delete</button>
    <label>Append template</label>
    <div each={e in templates}>
      <button class="quest-template" onclick={useTemplate}>{e.name}</button>
    </div>
  </div>

  <script>
    var self = this
    var app = this.opts.app || window.app
    self.world = app.nullWorld()
    self.warnings = []
    self.formattedText = null
    self.preview = null
    self.selected = null
    self.icons = 'square bar pillar bookmark star rhomb drop triangle chevron trader enter exit heart shield bolt'.split(' ')
    self.templates = [
      { name: 'Hint', template: '<hint layout="trader">message</hint>' },
      { name: 'Add to quest list', template: '<add-to-quest-list/>' },
      { name: 'Mark on map', template: '<mark-on-map dest="" />' },
      { name: 'Remove map marker', template: '<remove-map-marker/>' },
      { name: 'Halt script', template: '<halt/>' },
      { name: 'Condition', template: '<condition state="space" have-item="" installed-item="" have-ship="" at-dest="" no-enemy-at-dest="" not-at-dest="" have-credits="" trigger="TRIGGER"/>' },
      { name: 'Dialog', template: '<dialog>"Hey hitchhiker!"</dialog>' },
      { name: 'Dialog with model', template: '<dialog model="portrait">"Hey hitchhiker!"</dialog>' },
      { name: 'Dialog with choice', template: '<dialog ok="YES PLEASE" cancel="NO THANKS">"Would you like some tea?"</dialog>' },
      { name: 'Dialog with goto', template: '<dialog ok="YES PLEASE" cancel="NO THANKS" ok-goto="mark1"  cancel-goto="mark2" >"Would you like some tea?"</dialog>' },
      { name: 'Mark', template: '<mark id="label"/>' },
      { name: 'Goto', template: '<goto mark="label"/>' },
      { name: 'Modify quest', template: '<modify-quest quest="Quest Name" goto-mark="label"/>' },
      { name: 'Travel', template: '<travel dest=""/>' },
      { name: 'Place item', template: '<place-item dest="" item=""/>' },
      { name: 'Place trader inventory', template: '<place-inventory dest="" item=""/>' },
      { name: 'Place enemy', template: '<place-enemy dest="" enemy="" loot="Armor;Gold"/>' },
      { name: 'Give credits', template: '<give credits=""/>' },
      { name: 'Give item', template: '<give item=""/>' },
      { name: 'Take credits', template: '<take credits=""/>' },
      { name: 'Take item', template: '<take item=""/>' },
      { name: 'Change ship', template: '<change-ship ship=""/>' },
      { name: 'Play animation', template: '<play animation="end-of-game"/>' },
      { name: 'Play audio', template: '<play audio="Ending"/>' },
      { name: 'Request review', template: '<request-review />' },
      { name: 'No Operation', template: '<noop/>' }
    ]
    self.allTags = () => app.allTags(self.world.quests).filter(e => e)

    self.filteredItems = function () {
      var predicate = self.refs.filterInput && self.refs.filterInput.predicate || (() => true)
      return self.world.quests.filter(predicate)
    }

    function getDialogs(quest) {
      var cleanup = s => s.replace(/^[\n ]+|[\n ]+$|`|_|\*/g, '')
      var dialogs = quest.xml.match(/>([^>]*)<\/dialog>/g) ||Â []
      return dialogs.map(e => cleanup(e.substr(1, e.length-10)))
    }

    self.popupFormattedText = function () {
      if (self.formattedText)
        self.formattedText = null
      else
        self.formattedText = self.filteredItems().filter(e => e.name != 'REFERENCE').map(q => `\n\n\n${q.name.toUpperCase()}\n---------\n${getDialogs(q).join('\n----\n')}`)
    }

    self.previewDialog = function () {
      if (self.preview) self.preview = null
      else self.preview = getDialogs(self.selected)
    }

    self.useTemplate = function (e) {
      var src = self.cmEditor.getValue()
      src = src + '\n' + e.item.e.template
      self.cmEditor.setValue(src)
    }

    self.itemChooser = function () {
      app.events.trigger('show-item-chooser', [])
    }

    self.add = function () {
      self.filter = ''
      self.world.quests.unshift({
        name: 'unnamed', xml: '', color: '0F0', icon: 'arrow', tags: self.refs.filterInput.type
      })
    }

    self.edit = function (e) {
      self.save()
      self.selected = e.item.quest
      self.cmEditor.setValue(e.item.quest.xml)
    }

    self.setFields = function () {
      if (self.selected) {
        self.selected.name = self.refs.nameField.value
        self.selected.color = self.toShortColor(self.refs.colorField.value)
        self.selected.icon = self.refs.iconSelect.value
        self.selected.tags = self.refs.tagsField.value
        self.selected.isFile = self.refs.isFileCheckbox.checked
      }
    }

    self.toShortColor = s => s[1] + s[3] + s[5]
    self.toLongColor = s => s ? '#' + s[0] + s[0] + s[1] + s[1] + s[2] + s[2] : '#888888'

    self.save = function () {
      if (self.selected) {
        self.selected.xml = self.cmEditor.getValue()
        self.warnings = validator.quest(self.world, self.selected)
      }
    }

    self.remove = function () {
      self.world.quests = _.filter(self.world.quests, q => q != self.selected)
    }

    self.up = function () {
      _.bubbleUp(self.world.quests, self.world.quests.findIndex(e => e == self.selected))
    }

    self.down = function () {
      _.bubbleDown(self.world.quests, self.world.quests.findIndex(e => e == self.selected))
    }

    function createEditor() {
      var textarea = document.getElementById('quest-editor')
      self.cmEditor = CodeMirror.fromTextArea(textarea, { 
        mode: 'xml',
        theme: 'mdn-like',
        lineWrapping: true
      })
      function setEditorSize() {
        self.cmEditor.setSize(window.innerWidth-251-200, window.innerHeight-26-26-19)
      }
      setEditorSize()
      self.resizeCallback = _.throttle(setEditorSize, 100)
      window.addEventListener('resize', self.resizeCallback)
    }

    function destroyEditor() {
      self.cmEditor.toTextArea()
      window.removeEventListener('resize', self.resizeCallback)
    }

    self.on('mount', function() {
      self.world = app.getWorld()
      createEditor()
      app.events.on('world-updated', self.update)
      app.events.on('save-entity', self.save)
      self.update()
    })

    self.on('before-unmount', function() {
      app.events.off('world-updated', self.update)
      app.events.off('save-entity', self.save)
      destroyEditor()
    })
  </script>

  <style>
    .quest-tools {
      z-index: 2;
    }
    .quest-template {
      margin-bottom: 2px;
      width: 95%;
    }
    .quest-preview {
      position: absolute;
      top: 100px;
      left: 0;
      right: 0;
    }
    .quest-preview div {
      width: 340px;
      height: 140px;
      margin: 10px auto;
      overflow: hidden;
      font-family: "Avenir Next Condensed", "Agency FB", "Impact";
      font-weight: 500;
      font-size: 18px;
      line-height: 120%;
      color: #ddd;
      background: black;
      border-radius: 2px;
      padding: 10px;
      box-shadow: 0 0 20px #888;
      white-space: pre-line;
    }
    .quest-all-formatted {
      display: block;
      width: 500px;
      height: 400px;
      color: #ddd;
      background: black;
      border-radius: 2px;
      padding: 10px;
      margin: 10px auto;
      box-shadow: 0 0 20px #888;
    }
  </style>

</quest-list>

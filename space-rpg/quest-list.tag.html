<quest-list>

  <div class="list">
    <div each={quest in quests} onclick={edit} class={ list_item: true, active: quest.title==active }>
      {quest.title}
    </div>
    <div><button onclick={add}>+ New Quest</button></div>
  </div>

  <div class="quest-tools">
    <input type="text" value={active} ref="nameField">
    <button onclick={save}>Save</button>
    <button onclick={remove}>Delete</button>
  </div>

  <script>
    var self = this

    self.quests = []
    self.active = null

    function loadQuests(world) {
      var dom = (new DOMParser()).parseFromString(world.quests, 'text/xml')
      self.quests = _.map(dom.getElementsByTagName('quest'), function (e) {
        return {
          title: e.getAttribute('title'),
          source: e.innerHTML.split('  ').join('').trim()
        }
      })
      self.update()
    }

    self.add = function () {
      self.quests.push({ title: 'unnamed', source: '' })
    }

    self.edit = function (e) {
      self.active = e.item.quest.title
      window.codeMirrorInstance.setValue(e.item.quest.source)
    }

    self.save = function () {
      var quest = _.findWhere(self.quests, { title: self.active })
      quest.title = self.refs.nameField.value
      quest.source = window.codeMirrorInstance.getValue()
      self.active = null
    }

    self.remove = function () {
      self.quests = _.filter(self.quests, q => q.title != self.active)
    }

    function questsXml() {
      var quests = self.quests.map(q => '<quest title="'+ q.title +'">'+q.source+'</quest>')
      return '<quests>' + quests.join('') + '</quests>'
    }

    self.on('mount', function() {
      window.events.on('world-updated', () => loadQuests(getWorld()))
      window.events.on('save-world', function () {
        var world = getWorld()
        world.quests = questsXml()
        saveWorld(world)
      })
      loadQuests(getWorld())
    })
  </script>

  <style>
    .quest-tools {
      position: fixed;
      top: 31px;
      left: 255px;
      z-index: 2;
    }
  </style>

</quest-list>

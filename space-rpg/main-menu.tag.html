<main-menu>
  <div class="main-menu">
    <a each={e in tabs} href="{e}.html" onclick={requestSave}
       class={ tab: true, active: page == e + '.html' }>{e}</a>
    <div class="file-tools">
      <i>{needsSave ? 'Unsaved' : 'Saved'}</i>
      <button onclick={loadDefault}>Load default</button>
      <button onclick={loadEmpty}>Clear all</button>
      <a class="button" ref="downloadLink" onmouseenter={primeDownloadLink} download="world.json" href='#'>Download</a>
      <label class=button for=file-input>Upload</label>
      <input id=file-input type=file ref=fileInput onchange={fileChanged} style="width: 150px; margin-right: 20px">
    </div>
  </div>
  <div class="validation-report" if={hasValidationError}>
    <div each={e in undefNodes}>Error: Destination <b>{e}</b> not defined</div>
    <div each={e in undefItems}>Error: Item <b>{e}</b> not defined</div>
    <div each={e in undefEnemies}>Error: Enemy <b>{e}</b> not defined</div>
    <div each={e in undefShips}>Error: Ship <b>{e}</b> not defined</div>
    <div each={e in undefModels}>Error: Model <b>{e}</b> not defined</div>
    <div each={e in undefCelestials}>Error: Celestial <b>{e}</b> not defined</div>
    <button onclick={validateWorld}>Update</button>
  </div>

  <script>
    var self = this
    self.page = 'index'
    self.tabs = ['map', 'celestials', 'models', 'ships', 'items', 'quests']
    self.undefinedItems = []
    self.undefinedNodes = []
    self.undefinedEnemies = []
    self.undefinedShips = []

    self.on('mount', function() {
      self.page = _.last(window.location.pathname.split('/'))
      self.update()
    })

    self.requestSave = () => window.events.trigger('save-world')
    self.loadDefault = () => _.fetch('world.json', loadWorld)
    self.loadEmpty = () => loadWorld(JSON.stringify(nullWorld()))
    self.fileChanged = () => _.readFile(self.refs.fileInput.files[0], loadWorld)
    self.primeDownloadLink = function () {
      window.events.trigger('save-world')
      self.refs.downloadLink.setAttribute('href', _.toDataUrl(_.stringify(getWorld(), { maxLength: 200 })))
    }

    self.validateWorld = function () {
      var world = getWorld()
      var referredItems = _.flatten([
        (world.quests.match(/item="[^"]*/gm) || []).map(e => e.substring(6).split(';')),
        world.enemies.map(e => e.inventory),
        world.destinations.map(e => e.treasures),
        world.destinations.map(e => e.trader && e.trader.inventory || [])
      ])
      var definedItems = world.items.map(e => e.name)
      self.undefItems = _.uniq(_.difference(referredItems, definedItems))

      var destRefs = world.quests.match(/dest="[^"]*/gm) || []
      var referredNodes = _.flatten(destRefs.map(e => e.substring(6).split(';')))
      var definedNodes = world.destinations.map(e => e.name)
      self.undefNodes = _.uniq(_.difference(referredNodes, definedNodes))

      var destEnemies = world.destinations.filter(e => e.enemy).map(e => e.enemy.type)
      var questEnemies = (world.quests.match(/enemy="[^"]*/gm) || []).map(e => e.substring(7))
      var referredEnemies = destEnemies.concat(questEnemies)
      var definedEnemies = world.enemies.map(e => e.name)
      self.undefEnemies = _.uniq(_.difference(referredEnemies, definedEnemies))

      var referredShips = (world.quests.match(/ship="[^"]*/gm) || []).map(e => e.substring(6))
      var definedShips = world.ships.map(e => e.name)
      self.undefShips = _.uniq(_.difference(referredShips, definedShips))

      var referredCelestials = world.destinations.map(e => e.style)
      var definedCelestials = world.celestials.map(e => e.id)
      self.undefCelestials = _.uniq(_.difference(referredCelestials, definedCelestials))

      var referredModels = _.flatten([
        world.celestials.filter(e => e.id.startsWith('anomaly-')).map(e => e.model),
        world.ships.map(e => e.visual)
      ])
      var definedModels = world.models.map(e => e.name)
      self.undefModels = _.uniq(_.difference(referredModels, definedModels))

      self.hasValidationError = [
        self.undefItems,
        self.undefNodes,
        self.undefEnemies,
        self.undefShips,
        self.undefModels,
        self.undefCelestials
      ].some(e => e.length)

      self.update()
    }

    self.needsSave = false
    function onUserInteraction() {
      self.needsSave = true
      self.update();
    }
    window.addEventListener('click', onUserInteraction, true)

    window.setInterval(function () {
      if (self.needsSave) window.events.trigger('save-world')
      self.needsSave = false
      self.update()
    }, 2000)

    self.validateWorld()
    window.setInterval(self.validateWorld, 5000)

    function loadWorld(data) {
      saveWorld(JSON.parse(data))
      window.events.trigger('world-updated')
    }

  </script>
  <style>
    .main-menu {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #f8f8f8;
      border-bottom: 1px solid #aaa;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12px;
    }
    i {
      color: #888;
      padding: 0 10px;
    }
    .file-tools {
      float: right;
      margin-top: 3px;
    }
    a.tab, a.tab:active, a.tab:hover, a.tab:visited {
      display: inline-block;
      text-decoration: none;
      color: #000;
      padding: 5px 10px;
    }
    a.tab.active {
      background: #ddd;
      border-left: 1px solid #ccc;
      border-right: 1px solid #ccc;
      font-weight: bold;
      box-shadow: 0 3px 6px #ccc inset;
    }
    .logo {
      font-style: italic;
    }
    .validation-report {
      position: fixed;
      bottom: 0;
      left: 25%;
      right: 25%;
      border: 1px solid #bbb;
      border-bottom: none;
      background: #eee;
      border-radius: 2px 2px 0 0;
      max-height: 80px;
      padding: 4px 10px;
      overflow: auto;
      z-index: 10;
    }
    .validation-report button {
      position: fixed;
      bottom: 5px;
      right: 25.5%;
    }
    .validation-report b {
      border: 1px solid #ddd;
      padding: 1px 3px;
      background: #fff;
      border-radius: 3px;
    }
  </style>
</main-menu>
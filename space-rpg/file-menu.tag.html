<file-menu>
  <div class="file-menu">
    <div if={s3.isNull}>
      No cloud storage is configured. Define a configuration to enable cloud saving:
      <pre>
localStorage.cloudStorage = \{
  awsConfig: \{
    region: AWS_REGION,
    accessKeyId: YOUR_KEY,
    secretAccessKey: YOUR_SECRET
  \},
  awsS3Bucket: YOUR_BUCKET
\}
      </pre>
    </div>
    <button onclick={download}>Download world from cloud storage</button>
    <button onclick={upload}>Upload world from cloud storage</button>
  </div>

  <script>

    var self = this

    self.cloudKey = 'worlds/world.json'
    
    self.download = function () {
      self.s3.getObject({ Key: self.cloudKey }, handleError(function (data) {
        loadWorld(data.Body.toString())
      }))
    }
    
    self.upload = function () {
      var world = getWorld()
      if (world.destinations.length) {
        var conf = { Key: self.cloudKey, Body: _.stringify(world), ACL: 'public-read' }
        self.s3.upload(conf, handleError(function (data) {
          alert('Successfully uploaded data');
        }))
      }
    }

    self.s3 = {
      isNull: true,
      getObject: (o, callback) => callback({ message: 'no cloud storage configured' }),
      upload: (o, callback) => callback({ message: 'no cloud storage configured' })
    }

    var conf = _.jsonParse(window.localStorage.cloudStorage)
    if (conf && conf.region && conf.accessKeyId && conf.secretAccessKey && conf.s3Bucket) {
      AWS.config.update({
        region: conf.region,
        accessKeyId: conf.accessKeyId,
        secretAccessKey: conf.secretAccessKey
      })
      self.s3 = new AWS.S3({ apiVersion: '2006-03-01', params: { Bucket: conf.s3Bucket } })
    }

    function handleError(callback) {
      return function (err, data) {
        if (err)
          alert('Error: ' + err.message);
        else
          callback(data);
      }
    }

    function loadWorld(data) {
      saveWorld(JSON.parse(data))
      window.events.trigger('world-updated')
    }
  </script>
  <style>
  .file-menu {
    margin: 20px 10px;
  }
  </style>
</file-menu>
<file-menu>
  <div class="sidebar file-menu">
    <label>Cloud storage</label>

    <div if={s3.isNull}>
      <i>Cloud storage not configured</i><br/>
      <button onclick={showCloudStorageHelp}>help</button>
    </div>
    <div if={!s3.isNull}>
      <button onclick={loadFromCloud}>Cloud load</button>
      <button onclick={saveToCloud}>Cloud save</button>
    </div>

    <label>File storage</label>
    <a class="button" ref="downloadLink" onmouseenter={primeDownloadLink} download="world.json" href='#'>Download file</a>
    <label class="button not-label" for=file-input>Upload file</label>
    <input id=file-input type=file ref=fileInput onchange={fileChanged} style="width: 150px; margin-right: 20px">

    <label>World</label>
    <button onclick={loadDefault}>Load default</button>
    <button onclick={loadEmpty}>Clear all</button>
  </div>

  <script>

    var cloudHelp = `Create a config object in localStorage to enable cloud saving

localStorage.cloudStorage = {
  s3Bucket: BUCKET,
  region: REGION,
  accessKeyId: KEY,
  secretAccessKey: SECRET
}`

    var self = this

    self.cloudKey = 'worlds/world.json'

    self.loadDefault = () => _.fetch('world.json', loadWorldFrom)
    self.loadEmpty = () => loadWorldFrom(JSON.stringify(nullWorld()))
    self.fileChanged = () => _.readFile(self.refs.fileInput.files[0], loadWorldFrom)
    self.primeDownloadLink = function () {
      window.events.trigger('save-world')
      self.refs.downloadLink.setAttribute('href', _.toDataUrl(_.stringify(getWorld(), { maxLength: 200 })))
    }
    self.showCloudStorageHelp = () => alert(cloudHelp)
    self.loadFromCloud = function (){
      if (confirm('Overwrite current world with cloud data?'))
        self.s3.getObject({ Key: self.cloudKey }, handleError(loadWorldFrom))
    }
    self.saveToCloud = function () {
      var world = getWorld()
      if (world.destinations.length) {
        var conf = { Key: self.cloudKey, Body: _.stringify(world), ACL: 'public-read' }
        self.s3.upload(conf, handleError(() => alert('Successfully uploaded data')))
      }
    }

    self.s3 = {
      isNull: true,
      getObject: (o, callback) => callback({ message: 'no cloud storage configured' }),
      upload: (o, callback) => callback({ message: 'no cloud storage configured' })
    }

    var conf = _.jsonParse(window.localStorage.cloudStorage)
    if (conf && conf.region && conf.accessKeyId && conf.secretAccessKey && conf.s3Bucket) {
      AWS.config.update({
        region: conf.region,
        accessKeyId: conf.accessKeyId,
        secretAccessKey: conf.secretAccessKey
      })
      self.s3 = new AWS.S3({ apiVersion: '2006-03-01', params: { Bucket: conf.s3Bucket } })
    }

    function handleError(callback) {
      return function (err, data) {
        if (err)
          alert('Error: ' + err.message);
        else
          callback(data.Body && data.Body.toString());
      }
    }

    function loadWorldFrom(data) {
      saveWorld(JSON.parse(data))
      window.events.trigger('world-updated')
    }
  </script>
  <style>
  .file-menu {
    z-index: 10;
    left: 2px;
    bottom: auto;
    right: initial;
    border-radius: 0 0 4px 4px;
    border-right: 1px solid #aaa;
    border-bottom: 1px solid #aaa;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
  </style>
</file-menu>
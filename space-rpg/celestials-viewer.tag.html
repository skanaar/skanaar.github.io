<celestials-viewer>

  <table>
    <tr each={row in rows()}>
      <td each={e in row} onclick={editCelestial}>
        <div>{e.id}</div>
        <div class="celestial" style="width: {e.r*2}px; height: {e.r*2}px; background: linear-gradient(0deg, #{e.color[0]}, #{e.color[1]})"></div>
      </td>
    </tr>
    <tr>
      <td>
        <button onclick={addCelestial}>+ New Celestial</button>
      </td>
    </tr>
  </table>

  <div class="sidebar" show={!!selected}>
    <input type=text ref="idField" value={selected && selected.id}>
    
    <label>Attributes</label>
    <div class="input-grid">
      <em>r</em> <input type=number ref="rField" value={selected && selected.r}><br/>
      <em>amb</em> <input type=number ref="ambField" value={selected && selected.amb}><br/>
      <em>oct</em> <input type=number step=1 ref="octField" value={selected && selected.oct}><br/>
      <em>zoom</em> <input type=number ref="zoomField" value={selected && selected.zoom}><br/>
      <em>color 1</em> <input type=text ref="color0Field" value={selected && selected.color[0]}><br/>
      <em>color 2</em> <input type=text ref="color1Field" value={selected && selected.color[1]}><br/>
    </div>

    <br/>
    <button onclick={endEditing}>Done</button>
  </div>

  <style>
    .celestial {
      display: inline-block;
      margin: 10px 0 0 0;
      border-radius: 200px;
    }
    td {
      vertical-align: top;
      text-align: center;
      padding: 10px;
      background: white;
    }
    td:hover {
      background: #eee;
    }
  </style>

  <script>
    var self = this

    self.world = { celestialStyles: [] }
    self.selected = null

    self.addCelestial = function () {
      var style = { id:'unnamed', r: 20, amb: 0.2, oct: 3, zoom: 10, color: ['888', 'D84']}
      self.world.celestialStyles.push(style)
    }
    
    self.editCelestial = function (e) {
      self.selected = e.item.e
    }
    
    self.endEditing = function (e) {
      self.selected.id = self.refs.idField.value
      self.selected.r = +self.refs.rField.value
      self.selected.amb = +self.refs.ambField.value
      self.selected.oct = +self.refs.octField.value
      self.selected.zoom = +self.refs.zoomField.value
      self.selected.color[0] = self.refs.color0Field.value
      self.selected.color[1] = self.refs.color1Field.value
      self.selected = null
      self.update()
    }

    self.rows = function () {
      var chunk = Math.ceil(Math.sqrt(self.world.celestialStyles.length))
      return _.range(chunk).map(i => self.world.celestialStyles.slice(i*chunk, i*chunk+chunk))
    }

    function loadWorld(w) {
        self.world = getWorld()
        self.update()
    }

    self.on('mount', function() {
      window.events.on('world-updated', loadWorld)
      window.events.on('save-world', () => saveWorld(self.world))
      loadWorld()
    })

  </script>

</celestials-viewer>

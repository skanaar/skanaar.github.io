<celestials-viewer>

  <div class="list">
    <div class="tools">
      <filter-tools ref="filterInput" types={types} onfilter={update} />
    </div>
    <div each={e in filteredItems()} onclick={edit} class={ list_item: true, active: e==selected }>
      {e.name}
    </div>
  </div>

  <div class="toolbox">
    <button onclick={add}>+ New Celestial</button>
    <button onclick={duplicate}>Duplicate</button>
    <button onclick={sort}>Sort list</button>
  </div>

  <div>
    <celestial-preview if={!!selected} celestial={selected} />
    <terrain-preview if={hasSurface()} surface={selected} />
  </div>

  <div class="sidebar" show={!!selected}>
    <select value={selection().type} ref="typeChooser">
      <option each={e in types}>{e}</option>
    </select>
    <input type=text ref="nameField" value={selection().name}>
    
    <label>Attributes</label>
    <div class="input-grid">
      <em>radius</em> <input type=number ref="rField" value={selection().radius}><br/>
      <em>height</em> <input type=number step=0.1 ref="heightField" value={selection().height}><br/>
      <em>ambient</em> <input type=number step=0.05 ref="ambField" value={selection().ambient}><br/>
      <em>octaves</em> <input type=number step=1 ref="octavesField" value={selection().octaves}><br/>
      <em>zoom</em> <input type=number step=0.1 ref="zoomField" value={selection().zoom}><br/>
      <em>falloff</em> <input type=number step=0.05 ref="falloffField" value={selection().falloff}><br/>
      <em>curve</em> <input type=text ref="curveField" value={selection().curve.join()}><br/>
      <em>spectrum</em> <input type=text ref="spectrumField" value={selection().spectrum}><br/>
    </div>

    <label if={hasModel()}>Model</label>
    <select show={hasModel()} value={selection().model} ref="modelChooser">
      <option each={e in world.models}>{e.name}</option>
    </select>

    <label></label>
    <button onclick={save}>Save</button>
    <button onclick={remove}>Delete</button>
  </div>

  <style>
    td {
      vertical-align: top;
      text-align: center;
      padding: 10px;
      background: white;
    }
    td:hover {
      background: #eee;
    }
  </style>

  <script>
    var self = this
    var app = self.opts.app || window.app

    self.world = { celestials: [] }
    self.selected = null
    self.currSurface = null
    self.currCelestial = null
    self.types = app.celestialTypes

    self.filteredItems = () => self.world.celestials.filter(self.refs.filterInput.predicate)

    self.selection = () => self.selected || { curve: [] }

    self.hasSurface = function () {
      return self.selected && ['planet', 'asteroid'].includes(self.selected.type)
    }

    self.hasModel = function () {
      return self.selected && ['anomaly'].includes(self.selected.type)
    }

    self.sort = function () {
      self.world.celestials.sort((a,b) => (a.name < b.name ? -1 : 1))
    }

    self.add = function () {
      var type = self.refs.filterInput.type || 'asteroid'
      var obj = {
        name: type + '-unnamed', type: type,
        radius: 4, height: 2, ambient: 0.2, octaves: 3, zoom: 1.5, falloff: 0.3,
        curve: [0,1], spectrum: ['F80', 'F80']
      }
      self.world.celestials.unshift(obj)
      self.edit({ item: { e: self.world.celestials[0] } })
    }

    self.duplicate = function () {
      var i = self.world.celestials.findIndex(e => e == self.selected)
      var obj = JSON.parse(JSON.stringify(self.selected))
      obj.name = obj.name + '-copy'
      self.world.celestials.splice(i, 0, obj)
      self.edit({ item: { e: obj } })
    }

    self.remove = function () {
      if (confirm('Delete celestial with name ' + self.selected.name))
        self.world.celestials = self.world.celestials.filter(e => e != self.selected)
    }
    
    self.edit = function (e) {
      self.selected = e.item.e
      self.currCelestial = self.selected.celestial
      self.currSurface = self.selected.surface
    }
    
    self.save = function () {
      if (!self.selected) return
      var identifier = self.refs.nameField.value.split('-')
      self.selected.type = self.refs.typeChooser.value
      identifier[0] = self.selected.type
      self.selected.name = identifier.join('-')
      if (self.hasModel()) {
        self.selected.model = self.refs.modelChooser.value || null
      } else {
        self.selected.model = null
      }
      self.selected.radius = +self.refs.rField.value
      self.selected.zoom = +self.refs.zoomField.value
      self.selected.height = +self.refs.heightField.value
      self.selected.ambient = +self.refs.ambField.value
      self.selected.octaves = +self.refs.octavesField.value
      self.selected.falloff = (+self.refs.falloffField.value) || 0.4
      self.selected.curve = self.refs.curveField.value.split(',').map(x => +x)
      self.selected.spectrum = self.refs.spectrumField.value.split(',')
    }

    function loadWorld() {
        self.world = app.getWorld()
        self.update()
    }

    self.on('mount', function() {
      app.events.on('world-updated', loadWorld)
      app.events.on('save-entity', self.save)
      loadWorld()
    })

    self.on('unmount', function() {
      app.events.off('world-updated', loadWorld)
      app.events.off('save-entity', self.save)
    })

  </script>

</celestials-viewer>
